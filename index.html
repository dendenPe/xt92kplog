<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Trade Log</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<style>
/* --- BASE STYLES --- */
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{
    font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
    background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
    min-height:100vh;
    padding:3mm 7mm; /* 3mm oben/unten, 7mm links/rechts */
    color:#1c1c1e; 
    overflow-x: hidden; 
    display: flex; 
    justify-content: center; 
    align-items: flex-start;
}

/* KARTEN-CONTAINER - FESTE DIMENSIONEN AN BROWSERFENSTER GEBUNDEN */
.container{
    width: calc(100vw - 14mm); /* 7mm links + 7mm rechts = 14mm Abzug */
    height: calc(100vh - 6mm); /* 3mm oben + 3mm unten = 6mm Abzug */
    margin: 0;
    background:white;
    border-radius:20px;
    box-shadow:0 20px 60px rgba(0,0,0,.3); 
    display: flex; 
    flex-direction: column; 
    overflow: hidden;
    /* Fixierte Positionierung */
    position: relative;
}

/* AUF MOBILE: VOLLE BILDSCHIRMGR√ñSSE OHNE ABST√ÑNDE */
@media(max-width: 768px) { 
    body { 
        padding: 0 !important; /* Keine Abst√§nde mehr auf Mobile */
        background: #f0f2f5; 
    }
    
    .container { 
        width: 100vw !important; /* Volle Breite */
        height: 100vh !important; /* Volle H√∂he */
        border-radius: 0 !important; /* Keine abgerundeten Ecken */
        box-shadow: none !important; /* Kein Schatten */
    }
}

.header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:10px 15px;text-align:center;border-radius:20px 20px 0 0; flex-shrink: 0;}
@media(max-width: 768px) { .header { border-radius: 0; padding-top: 20px; } }

.header h1{font-size:1.0em;margin-bottom:4px}
.backup-status{font-size:.75em;opacity:.9;margin-top:8px; display:inline-block; background:rgba(0,0,0,0.2); padding:2px 8px; border-radius:10px;}

/* NAVIGATION - BREITER */
.nav{display:flex;background:#f8f9fa;border-bottom:2px solid #e9ecef;overflow-x:auto; -webkit-overflow-scrolling: touch; flex-shrink: 0; position: sticky; top: 0; z-index: 100;}
.nav-btn{flex:1;min-width:100px;padding:10px 5px;background:none;border:none;cursor:pointer;font-size:0.9em;font-weight:600;color:#495057;white-space:nowrap; transition: background 0.2s;}
.nav-btn.active{background:white;color:#667eea;border-bottom:3px solid #667eea}

@media(max-width: 768px) {
    .nav-btn {
        padding: 16px 8px;
        font-size: 0.85em; 
        min-width: auto;   
    }
}

/* CONTENT - MIT SCROLL INNERHALB DER KARTE */
.content{padding:20px; flex-grow: 1; overflow-y: auto; height: calc(100% - 100px);}
@media(max-width: 768px) { .content { background: #f2f2f7; height: calc(100% - 120px); padding: 15px; } }
.view{display:none; animation: fadeIn 0.2s ease; height: 100%;}
.view.active{display:flex; flex-direction: column;}
@keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

/* CALENDAR LAYOUT MIT ANPASSUNGEN F√úR MOBILE */
.calendar-layout {
    display: flex;
    gap: 20px;
    height: 100%;
    flex-grow: 1;
}

@media(max-width: 768px) {
    .calendar-layout {
        flex-direction: column;
        height: auto;
    }
}

.calendar-section {
    display: flex;
    flex-direction: column;
    height: 100%;
}

.calendar-section.left {
    flex: 1.1; /* 10% breiter */
}

/* ERG√ÑNZE DIESE CSS-STYLES */
.calendar-section.right {
    flex: 0.9;
    display: flex;
    flex-direction: column;
    gap: 20px;
    height: 100%;
}

.calendar-top-card,
.calendar-bottom-card {
    background: #ffffff;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 20px 50px rgba(0,0,0,0.3);
    border: 1px solid rgba(0,0,0,0.02);
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.calendar-top-card {
    flex: 1.2; /* Etwas gr√∂√üer f√ºr den Finanzkalender */
    min-height: 548px; /* Mindesth√∂he */
}

.calendar-bottom-card {
    flex: 0.8; /* Etwas kleiner f√ºr die Statistik */
    min-height: 402px; /* Mindesth√∂he */
}

/* Hochwertige Statistik-Karte */
.month-stats-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
    margin-bottom: 20px;
}

.month-stat-card {
    background: #fafafa;
    border-radius: 8px;
    padding: 12px;
    text-align: center;
    border: 1px solid #f0f0f0;
}

.month-stat-label {
    font-size: 0.7em;
    color: #868e96;
    margin-bottom: 4px;
    font-weight: 300;
    letter-spacing: 0.5px;
}

.month-stat-value {
    font-size: 1.1em;
    font-weight: 600;
    color: #495057;
}

.month-stat-value.profit {
    color: #37b24d;
}

.month-stat-value.loss {
    color: #fa5252;
}

/* D√ºnnes Balkendiagramm */
.month-bars-container {
    display: flex;
    align-items: flex-end; /* WICHTIG: Balken starten unten */
    height: 120px;
    padding: 10px 0;
    background: #fafafa;
    border-radius: 6px;
    margin-top: 10px;
    position: relative; /* WICHTIG f√ºr absolute Positionierung */
    justify-content: space-around;
}

.month-bar-wrapper {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    margin: 0 1px;
    height: 100%;
    justify-content: flex-end; /* Balken starten am Boden */
}

.month-bar {
    width: 6px; /* Sehr d√ºnne Balken */
    min-height: 1px;
    border-radius: 1px;
    background: linear-gradient(to top, #667eea, #764ba2);
    transition: height 0.3s ease;
}

.month-bar.profit {
    background: linear-gradient(to top, #37b24d, #51cf66);
}

.month-bar.loss {
    background: linear-gradient(to top, #fa5252, #ff6b6b);
}

.month-bar-label {
    font-size: 0.6em;
    color: #868e96;
    margin-top: 4px;
    font-weight: 300;
}

/* Null-Linie f√ºr das Diagramm */
.zero-line-month {
    display: none; /* Unsichtbar machen, da wir inline-Styles verwenden */
}

/* Auf Mobile: Beide Karten untereinander */
@media(max-width: 768px) {
    .calendar-section.right {
        flex: none;
        height: auto;
        gap: 15px;
    }
    
    .calendar-top-card,
    .calendar-bottom-card {
        height: auto;
        min-height: auto;
        margin-bottom: 15px;
    }
    
    .calendar-bottom-card {
        order: 3; /* Kommt nach dem Finanzkalender */
    }
}

/* STATS IM KALENDER - NEBENEINANDER */
.stats {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    padding: 10px;
}

@media(max-width: 768px) {
    .stats {
        flex-direction: column;
        gap: 8px;
    }
}

.stats .stat-card {
    flex: 1;
    background: white;
    padding: 10px;
    border-radius: 8px;
    text-align: center;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    min-height: auto;
}

.stats .stat-label {
    font-size: 0.75em;
    color: #868e96;
    margin-bottom: 6px;
    white-space: nowrap;
}

.stats .stat-value {
    font-size: 1.1em;
    font-weight: 700;
}

.stats .stat-value.profit {
    color: #37b24d;
}

.stats .stat-value.loss {
    color: #fa5252;
}

/* FORMS - BREITER */
.form-group{margin-bottom:15px; background: white; border-radius: 10px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);}
@media(max-width: 768px) { .form-group { margin-bottom: 15px;} }

.form-group label{display:block;margin-bottom:8px;font-weight:600;color:#495057; font-size: 0.85em; text-transform: uppercase;}
.form-group input, .form-group textarea, .form-group select{width:100%;padding:14px;border:2px solid #e9ecef;border-radius:8px;font-size:18px;font-family:inherit; font-weight: 600;}
@media(max-width: 768px) { .form-group input, .form-group textarea, .form-group select { border: none; border-bottom: 1px solid #e5e5ea; border-radius: 0; padding: 8px 0; } }
.form-group input:focus, .form-group textarea:focus, .form-group select:focus{outline:none;border-color:#667eea}

/* BUTTONS */
.btn{width:100%;padding:16px;color:white;border:none;border-radius:8px;font-size:1.1em;font-weight:600;cursor:pointer;margin-bottom:10px; transition: transform 0.1s; text-align: center;}
.btn:active { transform: scale(0.98); opacity: 0.9; }
.btn-sm { padding: 8px 12px; font-size: 0.9em; width: auto; display: inline-block; }
.btn-primary{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)}
.btn-success{background:linear-gradient(135deg,#51cf66 0%,#37b24d 100%)}
.btn-info{background:linear-gradient(135deg,#339af0 0%,#1971c2 100%)}
.btn-sync{background:linear-gradient(135deg,#ff922b 0%,#fd7e14 100%);}
.btn-outline { background: transparent; border: 2px solid #e9ecef; color: #495057; }
@media(max-width: 768px) { .btn-outline { background: white; } }
.btn-reconnect{background:#fff3bf;color:#e67700;border:1px solid #fcc419;margin-top:10px}
.btn-delete-small{background:#ff3b30;color:white;border:none;border-radius:6px;padding:5px 10px;font-size:0.8em; width: 100%; margin-top: 5px;}

/* CALENDAR - LINKSB√úNDIG */
.calendar{display:grid; gap:8px; margin-top:15px; flex-grow: 1;}
@media(max-width: 768px) { .calendar { gap: 4px; } }

.calendar-header{text-align:center;font-weight:600;padding:8px;background:#f8f9fa;border-radius:6px;font-size:.85em}
.calendar-day{position:relative; aspect-ratio:1;border-radius:8px;padding:4px;display:flex;flex-direction:column;justify-content:center;align-items:center;font-weight:600;cursor:pointer;min-height:60px; background: #f8f9fa;}
@media(max-width: 768px) { .calendar-day { background: white; box-shadow: 0 1px 2px rgba(0,0,0,0.05); min-height: auto; } }

.calendar-day.empty{background:transparent;cursor:default; box-shadow: none;}
.calendar-day.future{background:#f8f9fa;color:#adb5bd; box-shadow: none;}
.calendar-day.profit{background:linear-gradient(135deg,#51cf66 0%,#37b24d 100%);color:white}
.calendar-day.loss{background:linear-gradient(135deg,#ff6b6b 0%,#fa5252 100%);color:white}
.calendar-day.weekend-hidden { visibility: hidden; pointer-events: none; }
.note-icon { position: absolute; top: 4px; right: 4px; font-size: 0.8em; opacity: 0.8; }
.day-number{font-size:.85em;margin-bottom:4px}
.day-pnl{font-size:.75em;font-weight:700}
@media(max-width: 768px) { .day-pnl { font-size: 0.65em; } .note-icon { top: 1px; right: 1px; font-size: 0.6em; } }

.month-selector{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding:12px;background:#f8f9fa;border-radius:8px}
@media(max-width: 768px) { .month-selector { background: white; } }
.month-selector button{padding:8px 12px;background:#667eea;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:600}
.month-selector h2{color:#495057;font-size:1.1em}

/* TRADINGVIEW WIDGET CONTAINER */
.tradingview-widget-container {
    width: 100%;
    height: 500px;
    border-radius: 10px;
    overflow: hidden;
    margin-bottom: 15px;
}

.tradingview-widget-container iframe {
    border: none;
}

.widget-info {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 12px;
    margin-top: 10px;
    font-size: 0.8em;
    color: #868e96;
    text-align: center;
}
/* TradingView Widget f√ºr Mobile anpassen */
@media(max-width: 768px) {
    .tradingview-widget-container {
        height: 800px !important; /* H√∂her f√ºr Mobile */
        min-height: 400px;
    }
}

/* STATS F√úR STATISTIK-TAB */
.stat-row{display:flex;justify-content:space-between;padding:10px;background:white;border-radius:8px;margin-bottom:6px;font-size:.9em}
.stat-row-label{color:#495057;font-weight:500}
.stat-row-value{font-weight:700}
.stat-row-value.profit{color:#37b24d} .stat-row-value.loss{color:#fa5252}

.stats-grid{display:grid;grid-template-columns:1fr;gap:12px;margin-bottom:20px}
@media(min-width:768px){.stats-grid{grid-template-columns:repeat(2,1fr)}}

.stat-card{background:#f8f9fa;padding:15px 10px;border-radius:8px;text-align:center}
@media(max-width: 768px) { .stat-card { background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.05); } }
.stat-label{font-size:.8em;color:#868e96;margin-bottom:6px}
.stat-value{font-size:1.3em;font-weight:700}
.stat-value.profit{color:#37b24d}
.stat-value.loss{color:#fa5252}

/* CHARTS */
.chart-container{background:#f8f9fa;padding:15px;border-radius:12px;margin-bottom:15px; position: relative;}
@media(max-width: 768px) { .chart-container { background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.05); } }
.chart-title{font-size:1em;font-weight:600;color:#495057;margin-bottom:12px;text-align:center}

/* General Bar Chart (Used for Fees and Daily PnL) */
.bar-chart{display:flex;align-items:flex-end;height:200px;padding:10px;background:white;border-radius:8px;overflow-x:auto;gap:3px}
.bar-wrapper{display:flex;flex-direction:column;align-items:center;min-width:25px; flex: 1;}
.bar{width:100%; max-width: 30px; min-height:2px;border-radius:3px 3px 0 0}
.bar.profit{background:linear-gradient(to top,#37b24d,#51cf66)}
.bar.loss{background:linear-gradient(to top,#fa5252,#ff6b6b)}
.bar.fee{background:linear-gradient(to top,#fab005,#ffd43b)}
.bar-label{font-size:.65em;color:#868e96;margin-top:4px;font-weight:600}
.bar-value{font-size:.6em;color:#495057;font-weight:600;margin-bottom:2px}

/* Zero-Line Trade Chart (Stats) */
.trade-chart-container {
    display: flex;
    height: 200px;
    background: white;
    border-radius: 8px;
    padding: 10px;
    align-items: stretch; /* Stretch to fill height */
    position: relative;
    width: 100%;
}
.trade-bar-wrapper {
    flex: 1;
    position: relative;
    height: 100%;
    margin: 0 1px;
}
.trade-bar-line {
    width: 100%;
    min-height: 2px;
    border-radius: 2px;
    position: absolute;
    /* Top/Bottom set via JS */
}
.trade-bar-line.profit { background: #37b24d; }
.trade-bar-line.loss { background: #fa5252; }
.zero-line {
    position: absolute;
    width: 100%;
    height: 1px;
    background: #e9ecef;
    top: 50%;
    left: 0;
    z-index: 0;
}

.line-chart{position:relative;height:250px;background:white;border-radius:8px;padding:20px 10px 30px 45px}
.line-chart svg{width:100%;height:100%;overflow:visible}

/* LISTS */
.month-summary{background:white;border-radius:8px;padding:15px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;border-left:4px solid #e9ecef; transition: transform 0.1s;}
.month-summary:active { transform: scale(0.98); background: #f1f3f5; }
@media(max-width: 768px) { .month-summary { background: #f9f9f9; box-shadow: none; border: 1px solid #f1f3f5; border-left-width: 4px; } }
.month-summary.current{border-left-color:#667eea;background:#f8f9ff}
.month-summary.profit{border-left-color:#37b24d}
.month-summary.loss{border-left-color:#fa5252}
.month-summary-left{flex:1}
.month-summary-title{font-weight:600;color:#495057;margin-bottom:4px}
.month-summary-subtitle{font-size:.8em;color:#868e96}
.month-summary-value{font-size:1.3em;font-weight:700;text-align:right}
.month-summary-value.profit{color:#37b24d}
.month-summary-value.loss{color:#fa5252}

/* MODAL */
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:1000;align-items:center;justify-content:center;padding:20px; backdrop-filter: blur(5px);}
.modal.active{display:flex}
.modal-content{background:white;padding:0;border-radius:15px;max-width:500px;width:100%; display:flex; flex-direction: column; max-height: 90vh; overflow: hidden;}
@media(max-width: 768px) { .modal-content { border-radius: 20px; width: 95%; } }
.modal-header{padding:20px; background:#f8f9fa; border-bottom:1px solid #e9ecef; text-align:center; font-weight:700; color:#495057;}
.modal-body{padding:20px; overflow-y: auto;}
.modal-tabs{display:flex; border-bottom:1px solid #e9ecef;}
.modal-tab{flex:1; padding:15px; text-align:center; cursor:pointer; font-weight:600; color:#868e96; background:#f8f9fa;}
.modal-tab.active{background:white; color:#667eea; border-bottom:3px solid #667eea;}
.trade-list-item{background:#f8f9fa; padding:10px; border-radius:8px; margin-bottom:10px; display:flex; flex-direction:column; gap:6px;}
.trade-time-group { display: flex; gap: 5px; font-size: 0.8em; color: #868e96; }
.trade-time-input { width: 100%; border: 1px solid #ced4da; border-radius: 4px; padding: 2px; }
.modal-footer{padding:20px; border-top:1px solid #e9ecef; display:flex; gap:10px;}
.btn-cancel{flex:1;padding:14px;background:#e9ecef;color:#495057;border:none;border-radius:8px;font-weight:600;cursor:pointer}
.btn-delete{flex:1;padding:14px;background:#fa5252;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer}

/* DAY DETAILS */
.day-detail-header { text-align: center; margin-bottom: 20px; }
.day-detail-total { font-size: 2em; font-weight: 800; margin-top: 5px; }
.day-detail-total.profit { color: #34c759; }
.day-detail-total.loss { color: #fa5252; }
.day-detail-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px; }
.detail-card { background: #f8f9fa; padding: 12px; border-radius: 8px; text-align: center; }
@media(max-width: 768px) { .detail-card { background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.05); } }
.detail-label { font-size: 0.75em; color: #868e96; text-transform: uppercase; margin-bottom: 4px; }
.detail-value { font-weight: 700; font-size: 1.1em; color: #495057; }
.trade-row { 
    display: grid; grid-template-columns: 60px 1fr 80px; gap: 15px; align-items: center; 
    padding: 15px; border-bottom: 1px solid #f1f3f5; background: white; 
}
.trade-row:last-child { border-bottom: none; }
.trade-time { font-size: 0.85em; color: #868e96; display: flex; flex-direction: column; }
.trade-duration { font-size: 0.8em; color: #adb5bd; }
.trade-bar-container { height: 8px; background: #e9ecef; border-radius: 4px; overflow: hidden; display: flex; }
.trade-bar-fill { height: 100%; border-radius: 4px; }
.trade-bar-fill.profit { background: #37b24d; }
.trade-bar-fill.loss { background: #fa5252; }
.trade-pnl { font-weight: 700; text-align: right; }
.trade-pnl.profit { color: #34c759; }
.trade-pnl.loss { color: #fa5252; }

/* WATERFALL CHART */
.waterfall-container { 
    background: white; padding: 10px; border-radius: 8px; 
    height: 220px; margin-bottom: 20px; 
    overflow-x: auto; /* Enable scrolling */
    display: flex; flex-direction: column; align-items: center;
}
.waterfall-chart { flex: 1; position: relative; justify-content: center; }
.waterfall-chart svg { height: 100%; display: block; }

/* TRADE STATS ROW */
.trade-stats-summary {
    display: flex; justify-content: space-around; margin-top: 15px; 
    background: white; padding: 10px; border-radius: 8px; 
    font-size: 0.9em; border: 1px solid #e9ecef;
}
.trade-stats-item strong { color: #495057; }

/* SUCCESS/WARNING MESSAGES */
.success-msg, .warning-msg {
    display: none;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 15px;
    text-align: center;
    font-weight: 600;
}
.success-msg {
    background: #d3f9d8;
    color: #2b8a3e;
}
.warning-msg {
    background: #fff3bf;
    color: #e67700;
}

/* --- FORMATIERUNG BEIBEHALTEN --- */
.info-box {
    background: #e7f5ff;
    color: #1971c2;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 15px;
    font-size: 0.9em;
    /* DAS IST NEU UND WICHTIG: */
    white-space: pre-wrap; /* Beh√§lt Zeilenumbr√ºche bei */
    line-height: 1.5;      /* Besserer Zeilenabstand f√ºr Listen */
    font-family: inherit;  /* Schriftart beibehalten */
}

/* TODAY TAB STYLES - BREITER */
.today-container { max-width: 800px; margin: 0 auto; width: 100%; }
.today-tabs { display: flex; background: #f8f9fa; border-radius: 8px; margin-bottom: 20px; overflow: hidden; }
@media(max-width: 768px) { .today-tabs { background: white; } }
.today-tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; font-weight: 600; color: #868e96; background: transparent; border: none; }
.today-tab.active { background: white; color: #667eea; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
.today-tab-content { display: none; }
.today-tab-content.active { display: block; }

/* F√úR EXTREM KLEINE BILDSCHIRME (Optional) */
@media(max-width: 320px) {
    body { 
        padding: 0 !important;
    }
    
    .container { 
        width: 100vw !important;
        height: 100vh !important;
    }

} 
.strategy-select {
    width: 100%;
    padding: 6px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 0.85em;
    background: #fff;
    margin-top: 5px;
    font-weight: 500;
}

/* --- SCREENSHOT STYLES (STABIL) --- */
.screenshot-container { 
    margin-top: 20px; 
    border-top: 1px solid #e9ecef; 
    padding-top: 15px; 
}

.screenshot-dropzone {
    border: 2px dashed #cbd5e0;
    border-radius: 8px;
    padding: 20px;
    text-align: center;
    color: #718096;
    background: #f8f9fa;
    cursor: pointer;
    margin-bottom: 15px;
}

.screenshot-dropzone:hover, .screenshot-dropzone.dragover {
    background: #e7f5ff;
    border-color: #667eea;
    color: #667eea;
}

/* HIER WAR DAS PROBLEM: Wir nutzen jetzt Flexbox statt Grid */
.preview-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 10px;
}

/* FESTE GR√ñSSE ERZWINGEN (100x100 Pixel) */
.preview-item {
    position: relative;
    width: 100px;        /* Festgenagelt */
    height: 100px;       /* Festgenagelt */
    border-radius: 8px;
    overflow: hidden;    /* Alles was √ºbersteht abschneiden */
    border: 1px solid #e9ecef;
    background: #fff;
    flex-shrink: 0;      /* Nicht zusammendr√ºcken lassen */
}

.preview-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;   /* Bild f√ºllt das Quadrat aus */
    display: block;
    cursor: pointer;
}

.btn-remove-img {
    position: absolute;
    top: 2px;
    right: 2px;
    background: rgba(255, 0, 0, 0.8);
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 12px;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 100; /* Sicherstellen, dass es √ºber dem Bild liegt */
}

/* --- STEUER VIEW STYLES --- */
.tax-subview { display: none; animation: fadeIn 0.3s ease; }
.tax-subview.active { display: block; }

.tax-nav-btn.active {
    background: #e7f5ff !important;
    color: #1971c2 !important;
    font-weight: bold;
    border: 1px solid #1971c2 !important;
}

</style>
</head>
<body>
<!-- HAUPTCONTAINER -->
<div class="container">
<div class="header">
<h1>Trade Log / Version 02i</h1>
<div class="backup-status" id="status">üîí Bereit</div>
</div>
<div class="nav">
<button class="nav-btn active" onclick="showView('today')">Heute</button>
<button class="nav-btn" onclick="showView('calendar')">Kalender</button>
<button class="nav-btn" onclick="showView('wealth')">Verm√∂gen</button>
<button class="nav-btn" onclick="showView('statistics')">Statistiken</button>
<button class="nav-btn" onclick="showView('tax')">Steuern</button>
<button class="nav-btn" onclick="showView('export')">Im/Export</button>
</div>
<div class="content">
<div id="today" class="view active">
<div class="success-msg" id="msg">Gespeichert! ‚úì</div>
<div class="warning-msg" id="warn"></div>
<div class="success-msg" id="syncMsg" style="display:none;background:#e7f5ff;color:#0c5460;"></div>
<div class="today-container">
<h2 style="text-align:center;margin-bottom:20px;color:#495057">PnL f√ºr Heute</h2>
<div class="form-group">
<label>Datum</label>
<input type="text" id="todayDate" readonly>
</div>

<div class="today-tabs">
<button class="today-tab active" onclick="switchTodayTab('simple')">Gesamt</button>
<button class="today-tab" onclick="switchTodayTab('trades')">Trades</button>
<button class="today-tab" onclick="switchTodayTab('notes')">Notiz</button>
</div>

<div id="today-simple" class="today-tab-content active">
<div class="form-group">
<label>Tages PnL ($)</label>
<input type="number" inputmode="decimal" step="0.01" id="todayPnL" placeholder="z.B. 250.50">
</div>
<p style="font-size:0.85em;color:#868e96;text-align:center;margin-top:-10px;">Gesamtsumme aller Trades</p>
</div>

<div id="today-trades" class="today-tab-content">
<div id="todayTradesList"></div>
<button class="btn btn-sm btn-info" onclick="addTodayTrade()" style="margin-top:10px;">+ Trade hinzuf√ºgen</button>
</div>

<div id="today-notes" class="today-tab-content">
    <div class="form-group">
        <label>üìù Tagesnotizen</label>
        <textarea id="todayNote" rows="6" placeholder="Marktbedingungen, Psychologie, Learnings..."></textarea>
    </div>
  
    <!-- NEUER BEREICH F√úR BILDER -->
    <div class="screenshot-container">
        <label style="display:block;margin-bottom:8px;font-weight:600;color:#495057;font-size:0.85em;text-transform:uppercase;">
            üì∏ Screenshots (Max 5)
        </label>
        
        <input type="file" id="screenshotInput" accept="image/jpeg, image/png, image/jpg" multiple style="display:none">
        
        <div class="screenshot-dropzone" id="screenshotDropzone">
            <span style="font-size: 2em; display: block; margin-bottom: 5px;">‚òÅÔ∏è</span>
            Bilder hier reinziehen oder klicken<br>
            <span style="font-size: 0.8em; opacity: 0.7;">(JPEG/PNG)</span>
        </div>

        <div id="screenshotPreviews" class="preview-grid">
            <!-- Hier erscheinen die Bilder -->
        </div>
    </div>
</div>

<button class="btn btn-primary" onclick="saveToday()">Speichern</button>
</div>
</div>

<!-- √ÑNDERE DEN KALENDER-BEREICH IM HTML -->
<div id="calendar" class="view">
    <div class="calendar-layout">
        <!-- LINKE SEITE: KALENDER -->
        <div class="calendar-section left">
            <div class="stats" id="calStats"></div>
            <div class="month-selector">
                <button onclick="changeMonth(-1)">‚Üê</button>
                <h2 id="monthTitle"></h2>
                <button onclick="changeMonth(1)">‚Üí</button>
            </div>
            <div id="calGrid" class="calendar"></div>
        </div>
        
        <!-- RECHTE SEITE: ZWEI KARTEN √úBEREINANDER -->
        <div class="calendar-section right">
            <!-- Obere Karte: TradingView Finanzkalender -->
            <div class="calendar-top-card">
                <h3 style="text-align:center;margin-bottom:15px;color:#495057">üìÖ Finanzkalender</h3>
                
                
                <!-- TradingView Economic Calendar Widget -->
                <div class="tradingview-widget-container">
                    <div class="tradingview-widget-container__widget"></div>
                    <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-events.js" async>
                    {
                        "width": "100%",
                        "height": "500",
                        "locale": "de_DE",
                        "importanceFilter": "-1,0,1",
                        "countryFilter": "us",
                        "currencyFilter": "USD",
                        "dateRange": "1M",
                        "colorTheme": "light",
                        "isTransparent": false,
                        "showDescription": true
                    }
                    </script>
                </div>
            </div>
            
            <!-- Untere Karte: Monats-Statistiken -->
            <div class="calendar-bottom-card">
                <h3 style="text-align:center;margin-bottom:15px;color:#495057">üìä Monats-Statistik</h3>
                <div id="monthStatsContent" style="flex-grow: 1;">
                    <!-- Wird via JavaScript bef√ºllt -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- DAY DETAILS -->
<div id="day-details" class="view">
    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
        <button class="btn btn-outline" style="flex: 1;" onclick="showView('calendar')">‚Üê Zur√ºck zum Kalender</button>
        <button class="btn btn-info" style="width: auto;" onclick="editCurrentDay()">‚úèÔ∏è Bearbeiten</button>
    </div>
    <div id="dayDetailContent"></div>
</div>

<!-- WEALTH VIEW -->
<div id="wealth" class="view">
<h2 style="text-align:center;margin-bottom:20px;color:#495057">üìà Verm√∂gensentwicklung</h2>
<div class="chart-container">
<div class="chart-title">Kumuliertes PnL (Gesamt)</div>
<div class="line-chart" id="wealthChart"></div>
</div>
<div class="chart-container">
<div class="chart-title">Monats√ºbersicht</div>
<div id="monthSummaries"></div>
</div>
</div>

<!-- STATISTICS VIEW -->
<div id="statistics" class="view">
<div class="month-selector">
<button onclick="changeStatsMonth(-1)">‚Üê</button>
<h2 id="statsTitle"></h2>
<button onclick="changeStatsMonth(1)">‚Üí</button>
</div>
<div class="stats" id="statsOverview"></div>

<div class="chart-container">
<div class="chart-title">üìà Verm√∂gensentwicklung (Kumuliert)</div>
<div class="line-chart" id="lineChart"></div>
</div>
<!-- STRATEGIE STATS -->
<div class="chart-container">
    <div class="chart-title">üß† Strategie Performance</div>
    <div id="strategyStats"></div>
</div>
<div class="chart-container">
<div class="chart-title">üí∏ Broker Geb√ºhren</div>
<div class="stat-row"><span class="stat-row-label">Gesamt (Lifetime)</span><span class="stat-row-value loss" id="lifetimeFees">0.00</span></div>
<div class="stat-row"><span class="stat-row-label">Dieser Monat</span><span class="stat-row-value loss" id="monthFees">0.00</span></div>
<div class="bar-chart" id="feeBarChart"></div>
</div>
<div class="chart-container">
<div class="chart-title">üìä T√§gliches PnL</div>
<div class="bar-chart" id="barChart"></div>
</div>
<div class="chart-container">
<div class="chart-title">üîé Einzeltrade-Performance</div>
<div id="tradeChartWrapper"></div>
<div id="tradeStatsRow" class="trade-stats-summary"></div>
</div>
<div class="chart-container">
<div class="chart-title">üìÖ Wochentag-Analyse (√ò PnL)</div>
<div class="bar-chart" id="weekdayChart"></div>
</div>
<div class="stats-grid">
<div class="chart-container">
<div class="chart-title">üí∞ Performance</div>
<div id="perf"></div>
</div>
<div class="chart-container">
<div class="chart-title">üéØ Streaks</div>
<div id="streak"></div>
</div>
</div>
<div class="chart-container">
<div class="chart-title">üìà Insights</div>
<div id="insights"></div>
</div>
</div>

<!-- === STEUER VIEW (NEU) === -->
<div id="tax" class="view">
    <h2 style="text-align:center;margin-bottom:15px;color:#2c3e50">üá®üá≠ Steuererkl√§rung (Schaffhausen)</h2>
    
    <!-- Navigation innerhalb des Steuer-Tabs -->
    <div style="display:flex; background:#f8f9fa; border-radius:8px; margin-bottom:20px; padding:5px; gap:5px;">
        <button class="btn-sm btn-outline tax-nav-btn active" onclick="switchTaxSubView('overview')" style="flex:1; border:none;">√úbersicht</button>
        <button class="btn-sm btn-outline tax-nav-btn" onclick="switchTaxSubView('personal')" style="flex:1; border:none;">Pers√∂nlich</button>
        <button class="btn-sm btn-outline tax-nav-btn" onclick="switchTaxSubView('expenses')" style="flex:1; border:none;">Ausgaben</button>
        <button class="btn-sm btn-outline tax-nav-btn" onclick="switchTaxSubView('balances')" style="flex:1; border:none;">Kontostand</button>
        <button class="btn-sm btn-outline tax-nav-btn" onclick="switchTaxSubView('export')" style="flex:1; border:none;">PDF Export</button>
    </div>

    <!-- 1. √úBERSICHT -->
    <div id="tax-overview" class="tax-subview active">
        <div class="chart-container">
            <div class="chart-title">üìä Jahres-Zusammenfassung</div>
            <div id="taxOverviewContent">Lade Daten...</div>
        </div>
    </div>

    <!-- 2. PERS√ñNLICHE DATEN -->
    <div id="tax-personal" class="tax-subview">
        <div class="chart-container">
            <div class="chart-title">üë§ Pers√∂nliche Angaben</div>
            <div class="info-box">Diese Daten werden f√ºr den PDF-Kopf ben√∂tigt und nur lokal gespeichert.</div>
            
            <div class="form-group"><label>Vorname Nachname</label><input type="text" id="taxName" placeholder="Max Mustermann"></div>
            <div class="form-group"><label>Strasse Nr.</label><input type="text" id="taxAddress" placeholder="Musterstrasse 1"></div>
            <div style="display:flex;gap:10px;">
                <div class="form-group" style="flex:1"><label>PLZ</label><input type="text" id="taxZip" placeholder="8200"></div>
                <div class="form-group" style="flex:2"><label>Ort</label><input type="text" id="taxCity" placeholder="Schaffhausen"></div>
            </div>
            <div class="form-group"><label>Steuer-ID / PID</label><input type="text" id="taxId" placeholder="123.456.789"></div>
            
            <button class="btn btn-primary" onclick="saveTaxData()">üíæ Daten speichern</button>
        </div>
    </div>

    <!-- 3. KONTOST√ÑNDE -->
    <div id="tax-balances" class="tax-subview">
        <div class="chart-container">
            <div class="chart-title">üí∞ Verm√∂gensnachweis (CHF)</div>
            <div class="info-box">Bitte gib hier die Kontost√§nde per 01.01. und 31.12. ein (f√ºr die Verm√∂genssteuer).</div>
            <div id="balanceEntries"></div>
            <button class="btn btn-info" onclick="addBalanceYear()" style="margin-top:10px;">+ Jahr hinzuf√ºgen</button>
        </div>
    </div>

<!-- 3. AUSGABEN (NEU) -->
   <!-- 3. AUSGABEN (MIT SPEICHER-BUTTON) -->
    <div id="tax-expenses" class="tax-subview">
        <div class="chart-container">
            <div class="chart-title">üí∏ Betriebsausgaben & Abz√ºge (CHF)</div>
            <div class="info-box">
                Hier Kosten erfassen (z.B. Software, Hardware, B√ºro).<br>
                Diese werden im PDF separat aufgelistet.
            </div>
            
            <div id="expenseEntries"></div>
            
            <div style="display:flex; gap:10px; margin-top:20px; border-top:1px solid #eee; padding-top:15px;">
                <button class="btn btn-info" onclick="addExpenseItem()">+ Neue Zeile</button>
                <button class="btn btn-primary" onclick="saveTaxData(false)">üíæ Ausgaben Speichern</button>
            </div>
        </div>
    </div>

    <!-- 4. EXPORT -->
    <div id="tax-export" class="tax-subview">
        <div class="chart-container">
            <div class="chart-title">üìÑ PDF Erstellen</div>
            
            <div class="form-group">
                <label>Steuerjahr ausw√§hlen</label>
                <select id="taxYearSelect" style="width:100%;padding:12px;border-radius:8px;"><option>Bitte w√§hlen...</option></select>
            </div>
            
            <div class="form-group">
                <label>USD/CHF Jahresmittelkurs (ESTV)</label>
                <input type="number" step="0.0001" id="taxExchangeRate" value="0.8500" placeholder="z.B. 0.8500">
                <small style="color:#666">Den offiziellen Kurs findest du bei der ESTV.</small>
            <div class="form-group">
                <label>EUR/CHF Mittelkurs (ESTV)</label>
                <input type="number" step="0.0001" id="taxExchangeRateEUR" value="0.9400">
            </div>
            </div>
            
            <button class="btn btn-success" onclick="generateTaxPDF()">üöÄ PDF Generieren (Schaffhausen)</button>
        </div>
    </div>
</div>

<!-- EXPORT VIEW -->
<div id="export" class="view">
<div style="max-width:800px;margin:0 auto; width: 100%;">
<h2 style="text-align:center;margin-bottom:15px;color:#495057">üì• Import / Export</h2>

<!-- NEU: ZIP Export Button (Hervorgehoben) -->
<button class="btn btn-primary" onclick="exportZIP()" style="margin-bottom:20px; py-3;">üì¶ ZIP Backup erstellen (Alles)</button>

<div class="info-box"><strong>üíæ Import:</strong> Lade deine gesicherten Daten (ZIP mit Bildern oder nur CSV)</div>
<input type="file" id="csvFile" accept=".csv" style="display:none">
<input type="file" id="zipFile" accept=".zip" style="display:none">
<button class="btn btn-info" onclick="document.getElementById('zipFile').click()">üì¶ ZIP Backup importieren</button>
<button class="btn btn-info" onclick="document.getElementById('csvFile').click()">üì• Nur CSV importieren</button>
<button class="btn btn-success" onclick="exportCSV()">üì§ Nur CSV Exportieren</button>

<div style="margin-top:30px;padding-top:20px;border-top:2px dashed #e9ecef" id="desktopSyncSection">
<h3 style="text-align:center;margin-bottom:10px;color:#495057">üîÑ Automatischer Sync</h3>
<div class="info-box" style="background:#fff3bf;color:#e67700">
<strong>Hinweis:</strong> Wenn du Chrome neu startest, muss der Zugriff aus Sicherheitsgr√ºnden einmalig best√§tigt werden.
</div>
<div id="syncControls" style="text-align:center">
<button class="btn btn-sync" onclick="setupSyncFolder()">üìÇ Backup-Ordner verkn√ºpfen</button>
</div>
<div id="syncStatus" style="text-align:center;font-size:0.85em;color:#868e96;margin-top:5px">Kein Ordner verkn√ºpft</div>
</div>

<div style="padding:12px;background:#f8f9fa;border-radius:8px;text-align:center;margin-top:20px">
<strong>Aktuelle Daten:</strong>
<div id="dataInfo" style="margin-top:8px"></div>
</div>
</div>
</div>
</div>

<!-- MODAL -->
<div id="modal" class="modal">
<div class="modal-content">
<div class="modal-header"><span id="modalTitle"></span></div>
<div class="modal-tabs">
<div class="modal-tab active" onclick="switchModalTab('simple')">Gesamt</div>
<div class="modal-tab" onclick="switchModalTab('trades')">Trades</div>
<div class="modal-tab" onclick="switchModalTab('notes')">Notiz</div>
</div>
<div class="modal-body">
<div id="tab-simple" style="display:block">
<div class="form-group">
<label>Tages PnL ($)</label>
<input type="number" inputmode="decimal" step="0.01" id="modalPnL" placeholder="0.00">
</div>
<p style="font-size:0.85em;color:#868e96;text-align:center">Gesamtsumme aller Trades</p>
</div>
<div id="tab-trades" style="display:none">
<div id="tradesList"></div>
<button class="btn btn-sm btn-info" onclick="addTradeRow()">+ Trade hinzuf√ºgen</button>
</div>
<div id="tab-notes" style="display:none">
    <div class="form-group">
        <label>Tagesnotizen</label>
        <textarea id="modalNote" rows="6" placeholder="Marktbedingungen, Psychologie..."></textarea>
    </div>
    
    <!-- HIER KOMMT DER NEUE BEREICH -->
    <div class="screenshot-container">
        <label style="display:block;margin-bottom:8px;font-weight:600;color:#495057;font-size:0.85em;text-transform:uppercase;">
            üì∏ Screenshots (Nachtrag)
        </label>
        
        <input type="file" id="modalScreenshotInput" accept="image/jpeg, image/png, image/jpg" multiple style="display:none">
        
        <div class="screenshot-dropzone" id="modalScreenshotDropzone">
            <span style="font-size: 2em; display: block; margin-bottom: 5px;">‚òÅÔ∏è</span>
            Bilder hier reinziehen<br>
            <span style="font-size: 0.8em; opacity: 0.7;">(JPEG/PNG)</span>
        </div>

        <div id="modalScreenshotPreviews" class="preview-grid" style="display:flex;flex-wrap:wrap;gap:10px;margin-top:10px;"></div>
    </div>
</div>
</div>
<div class="modal-footer">
<button class="btn-cancel" onclick="closeModal()">Abbrechen</button>
<button class="btn btn-primary" onclick="saveModal()" style="flex:1">Speichern</button>
<button class="btn-delete" id="delBtn" onclick="deleteEntry()" style="display:none;width:auto">üóëÔ∏è</button>
</div>
</div>
</div>

<script>
    const STRATEGIES = [
    { id: '', label: '---' },
    { id: 'rev-long', label: 'Reversal Long üü¢' },
    { id: 'rev-short', label: 'Reversal Short üî¥' },
    { id: 'cont-long', label: 'Cont. Long üü¢' },
    { id: 'cont-short', label: 'Cont. Short üî¥' }
];
let calMonth=new Date(),statsMonth=new Date(),data={},selDate=null,dataCount=0,cachedDirHandle=null;
let currentTrades = [];
let todayTrades = [];
let todayScreenshots = []; // Neue Variable f√ºr die Bilder

// --- HELPER ---
function getEntry(key) {
    let entry = data[key];
    if (typeof entry === 'undefined') return { total: 0, trades: [], note: '' };
    if (typeof entry === 'number') return { total: entry, trades: [], note: '' };
    if (!entry.trades) entry.trades = [];
    if (!entry.note) entry.note = '';
    return entry;
}

function getComm(inst, qty) {
    let q = parseFloat(qty);
    if(isNaN(q)) q = 1;
    const i = inst || 'ES';
    if(i === 'ES' || i === 'NQ') return 4.50 * q;
    if(i === 'MES') return 1.00 * q;
    return 0;
}

// --- DATABASE SETUP (UPDATED FOR IMAGES) ---
const DB_NAME = 'TradingPnL_DB';
const DB_VERSION = 2; // WICHTIG: Version erh√∂ht!
const STORE_SETTINGS = 'settings';
const STORE_IMAGES = 'images'; // Neuer Speicherort f√ºr Bilder

function openDB() {
    return new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, DB_VERSION);
        
        req.onupgradeneeded = (e) => {
            const db = e.target.result;
            // Settings Store (existiert schon, aber wir pr√ºfen sicherheitshalber)
            if (!db.objectStoreNames.contains(STORE_SETTINGS)) {
                db.createObjectStore(STORE_SETTINGS);
            }
            // Images Store (NEU)
            if (!db.objectStoreNames.contains(STORE_IMAGES)) {
                db.createObjectStore(STORE_IMAGES);
            }
        };
        
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
    });
}

// Hilfsfunktionen f√ºr Bilder
async function saveImageToDB(id, blob) {
    const db = await openDB();
    const tx = db.transaction(STORE_IMAGES, 'readwrite');
    tx.objectStore(STORE_IMAGES).put(blob, id);
    return tx.complete;
}

async function getImageFromDB(id) {
    const db = await openDB();
    return new Promise((resolve) => {
        const tx = db.transaction(STORE_IMAGES, 'readonly');
        const req = tx.objectStore(STORE_IMAGES).get(id);
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => resolve(null);
    });
}


// --- SYNC LOGIC (DESKTOP ONLY) ---
async function saveDirHandle(handle) {
    const db = await openDB();
    const tx = db.transaction(STORE_NAME, 'readwrite');
    tx.objectStore(STORE_NAME).put(handle, 'backup_dir_handle');
    cachedDirHandle = handle;
    updateSyncUI(true);
}

async function getDirHandle() {
    const db = await openDB();
    return new Promise((resolve) => {
        const tx = db.transaction(STORE_NAME, 'readonly');
        const req = tx.objectStore(STORE_NAME).get('backup_dir_handle');
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => resolve(null);
    });
}

function updateSyncUI(linked, needPermission = false) {
    const statusEl = document.getElementById('syncStatus');
    const controlsEl = document.getElementById('syncControls');
    if (linked) {
        if (needPermission) {
            statusEl.textContent = '‚ö†Ô∏è Zugriff pausiert';
            statusEl.style.color = '#e67700';
            controlsEl.innerHTML = '<button class="btn btn-reconnect" onclick="restorePermission()">üîÑ Sync Starten (Zugriff erlauben)</button>';
        } else {
            statusEl.textContent = '‚úÖ Automatisch aktiv';
            statusEl.style.color = '#2b8a3e';
            controlsEl.innerHTML = '<button class="btn btn-sync" onclick="setupSyncFolder()" style="opacity:0.7">üìÇ Ordner √§ndern</button>';
        }
    } else {
        statusEl.textContent = 'Kein Ordner verkn√ºpft';
        statusEl.style.color = '#868e96';
        controlsEl.innerHTML = '<button class="btn btn-sync" onclick="setupSyncFolder()">üìÇ Backup-Ordner verkn√ºpfen</button>';
    }
}

async function setupSyncFolder() {
    if (!('showDirectoryPicker' in window)) { alert("Browser nicht unterst√ºtzt."); return; }
    try {
        const handle = await window.showDirectoryPicker();
        await saveDirHandle(handle);
        runSync(handle);
    } catch (e) { if (e.name !== 'AbortError') alert('Fehler: ' + e.message); }
}

async function restorePermission() {
    if (!cachedDirHandle) cachedDirHandle = await getDirHandle();
    if (!cachedDirHandle) return;
    try {
        const permission = await cachedDirHandle.requestPermission({ mode: 'read' });
        if (permission === 'granted') runSync(cachedDirHandle);
        else alert("Zugriff verweigert.");
    } catch (e) { alert("Fehler beim Zugriff."); }
}

async function initSyncCheck() {
    if (!('showDirectoryPicker' in window)) {
        document.getElementById('desktopSyncSection').style.display = 'none';
        return;
    }
    
    cachedDirHandle = await getDirHandle();
    if (!cachedDirHandle) { updateSyncUI(false); return; }
    const opts = { mode: 'read' };
    const permState = await cachedDirHandle.queryPermission(opts);
    if (permState === 'granted') { updateSyncUI(true, false); runSync(cachedDirHandle); }
    else { updateSyncUI(true, true); }
}

async function runSync(dirHandle) {
    try {
        updateSyncUI(true, false);
        const files = [];
        for await (const entry of dirHandle.values()) {
            if (entry.kind === 'file' && entry.name.endsWith('.csv')) {
                const match = entry.name.match(/pnl_(\d{4}-\d{2}-\d{2})\.csv/);
                if (match) files.push({ handle: entry, date: new Date(match[1]), name: entry.name });
            }
        }
        if (files.length === 0) return;
        files.sort((a, b) => b.date - a.date);
        const newest = files[0];
        const fileData = await newest.handle.getFile();
        const text = await fileData.text();
        const importData = parseCSV(text);
        const currentCount = Object.keys(data).length;
        const importCount = Object.keys(importData).length;
        if (importCount > currentCount) {
            data = importData;
            save(); init(); 
            showSyncMessage(`üîÑ Auto-Sync: ${importCount-currentCount} neue Eintr√§ge aus ${newest.name}`);
        }
    } catch (e) { console.error("Sync Error:", e); updateSyncUI(true, true); }
}

// --- ROBUST CSV PARSER V19 (STATE MACHINE) ---
// --- ROBUST CSV PARSER (MIT MULTILINE SUPPORT) ---
// --- SMART IMPORT LOGIC ---
function parseCSV(csvText) {
    // 1. Erkennung: Ist es eine TradingView/IBKR Datei?
    // Merkmal: Header enth√§lt "Symbol" und "Side" und "Fill Price"
    const firstLine = csvText.split('\n')[0];
    if (firstLine.includes('Symbol') && firstLine.includes('Fill Price') && firstLine.includes('Commission')) {
        return parseTradingViewCSV(csvText);
    }

    // 2. Fallback: Unser normales Format
    return parseStandardCSV(csvText);
}

// Dies ist deine ALTE parseCSV Funktion, nur umbenannt
function parseStandardCSV(csvText) {
    const rows = [];
    let currentRow = [];
    let currentVal = '';
    let inQuote = false;
    const text = csvText.replace(/\r\n/g, '\n').replace(/\r/g, '\n');

    for (let i = 0; i < text.length; i++) {
        let char = text[i];
        let nextChar = text[i+1];
        if (inQuote) {
            if (char === '"' && nextChar === '"') { currentVal += '"'; i++; } 
            else if (char === '"') { inQuote = false; } 
            else { currentVal += char; }
        } else {
            if (char === '"') { inQuote = true; } 
            else if (char === ',' || char === ';') { currentRow.push(currentVal); currentVal = ''; } 
            else if (char === '\n') { currentRow.push(currentVal); rows.push(currentRow); currentRow = []; currentVal = ''; } 
            else { currentVal += char; }
        }
    }
    if (currentVal || currentRow.length > 0) { currentRow.push(currentVal); rows.push(currentRow); }

    const result = {};
    rows.forEach((parts, i) => {
        if (i === 0 || parts.length < 2) return;
        let dateStr = parts[0].trim();
        let valStr = parts[1].trim();
        let note = parts[2] ? parts[2] : ""; 
        let details = parts[3] ? parts[3].trim() : "";
        let screensStr = parts[4] ? parts[4].trim() : "";

        if (valStr.includes(',') && valStr.includes('.')) {
            if (valStr.lastIndexOf('.') > valStr.lastIndexOf(',')) valStr = valStr.replace(/,/g, '');
            else valStr = valStr.replace(/\./g, '').replace(',', '.');
        } else if (valStr.includes(',')) valStr = valStr.replace(',', '.');
        
        const [d, m, y] = dateStr.split('.');
        if (d && m && y) {
            const key = `${y}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`;
            const val = parseFloat(valStr);
            if (!isNaN(val)) {
                let trades = []; let screenshots = [];
                try { if(details) trades = JSON.parse(details); } catch(e){}
                try { if(screensStr) screenshots = JSON.parse(screensStr); } catch(e){}
                result[key] = { total: val, trades: trades, note: note, screenshots: screenshots };
            }
        }
    });
    return result;
}

// --- INTELLIGENTER PARSER (NUR FUTURES + NETTO PNL) ---
function parseTradingViewCSV(csvText) {
    const rows = csvText.split('\n').map(r => r.trim()).filter(r => r);
    const header = rows[0].split(',');
    
    // Spalten-Indexe finden
    let idxComm = -1;
    header.forEach((h, i) => {
        if(h.toLowerCase().includes('commission') || h.toLowerCase().includes('comm')) idxComm = i;
    });
    if(idxComm === -1) idxComm = 6; 

    const idxSym=0, idxSide=1, idxQty=2, idxPrice=3, idxTime=4, idxNet=5;
    
    const fills = [];
    
    for(let i=1; i<rows.length; i++) {
        const cols = rows[i].split(',');
        if(cols.length < 5) continue;
        
        const symbol = cols[idxSym]; // z.B. "Mar20 '26" oder "EVO"
        const netAmount = parseFloat(cols[idxNet]);
        const price = parseFloat(cols[idxPrice]);
        const qty = parseFloat(cols[idxQty]);
        
        let commVal = 0;
        if(cols[idxComm]) {
            commVal = parseFloat(cols[idxComm]);
            if(isNaN(commVal)) commVal = 0;
        }
        
        // Multiplier Auto-Detect
        let multiplier = 1;
        if (price > 0 && qty > 0 && netAmount !== 0) {
            multiplier = Math.round(Math.abs(netAmount) / (price * qty));
        }
        
        // ====================================================
        // FILTER: NUR FUTURES ERLAUBEN (ES, NQ, MES...)
        // ====================================================
        // Logik: Futures haben im IBKR-Export meist ein Jahr im Namen (z.B. '26) 
        // UND einen Multiplier != 1 (z.B. 5 oder 50).
        // Aktien (EVO) haben Multiplier 1 und meist keine Zahlen im Symbol.
        
        if (multiplier === 1 && !symbol.match(/\d/)) {
            // Wenn Multiplier 1 ist UND keine Zahl im Symbol vorkommt -> Es ist eine Aktie (EVO)
            console.log("Ignoriere Aktie/Non-Future:", symbol);
            continue; // √úberspringen!
        }
        // ====================================================
        
        fills.push({
            time: new Date(cols[idxTime]),
            symbol: symbol,
            side: cols[idxSide],
            qty: qty,
            price: price,
            multiplier: multiplier,
            comm: commVal 
        });
    }
    
    fills.sort((a,b) => a.time - b.time);
    
    const result = {}; 
    const openPositions = []; 

    fills.forEach(fill => {
        const dateKey = dk(fill.time);
        if(!result[dateKey]) result[dateKey] = { total: 0, fees: 0, trades: [] };
        
        result[dateKey].fees += fill.comm;
        
        for(let q=0; q < fill.qty; q++) {
            const matchIndex = openPositions.findIndex(p => p.side !== fill.side && p.symbol === fill.symbol);
            
            if(matchIndex !== -1) {
                const openPos = openPositions[matchIndex];
                openPositions.splice(matchIndex, 1); 
                
                let pnl = 0;
                if(openPos.side === 'Buy') {
                    pnl = (fill.price - openPos.price) * fill.multiplier;
                } else {
                    pnl = (openPos.price - fill.price) * fill.multiplier;
                }
                
                const exitComm = fill.comm / fill.qty;
                const entryComm = openPos.comm; 
                pnl = pnl - exitComm - entryComm;

                const tradeEntry = {
                    pnl: parseFloat(pnl.toFixed(2)),
                    start: openPos.time.toTimeString().slice(0,5),
                    end: fill.time.toTimeString().slice(0,5),
                    inst: fill.symbol.split(' ')[0], 
                    qty: 1,
                    tag: ''
                };
                result[dateKey].trades.push(tradeEntry);
                
            } else {
                openPositions.push({
                    side: fill.side,
                    price: fill.price,
                    time: fill.time,
                    symbol: fill.symbol,
                    comm: fill.comm / fill.qty 
                });
            }
        }
    });
    
    for (const key in result) {
        const grossPnL = result[key].trades.reduce((sum, t) => sum + t.pnl, 0);
        result[key].total = parseFloat(grossPnL.toFixed(2));
        result[key].fees = parseFloat(result[key].fees.toFixed(2));
    }
    
    return result;
}

function showSyncMessage(txt) {
    const el = document.getElementById('syncMsg');
    el.textContent = txt;
    el.style.display = 'block';
    setTimeout(() => el.style.display = 'none', 6000);
}

// --- STANDARD FUNCTIONS ---

function fd(d){return`${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}.${d.getFullYear()}`}
function dk(d){return`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`}

function save(){
    const s=JSON.stringify(data);
    localStorage.setItem('tradingPnL_backup3',localStorage.getItem('tradingPnL_backup2')||s);
    localStorage.setItem('tradingPnL_backup2',localStorage.getItem('tradingPnL_backup1')||s);
    localStorage.setItem('tradingPnL_backup1',localStorage.getItem('tradingPnL_backup1')||s);
    localStorage.setItem('tradingPnL',s);
    localStorage.setItem('tradingPnL_count',Object.keys(data).length.toString());
    updateStatus();
}

function updateStatus(){ document.getElementById('status').textContent=`üîí ${Object.keys(data).length} Eintr√§ge gesichert`; }

function load(){
    try{
        const l=localStorage.getItem('tradingPnL');
        if(l) {
            data=JSON.parse(l);
            Object.keys(data).forEach(k => {
                if(typeof data[k] === 'number') data[k] = { total: data[k], trades: [], note: '' };
            });
        }
        init();
        initSyncCheck();
    }catch(e){console.error(e);init()}
}

async function init(){
    const t=new Date();
    document.getElementById('todayDate').value=fd(t);
    const k=dk(t);
    const entry = getEntry(k);
    
    // 1. Textdaten laden
    if(data[k]) {
        document.getElementById('todayPnL').value = entry.total;
        document.getElementById('todayNote').value = entry.note || '';
        todayTrades = entry.trades ? JSON.parse(JSON.stringify(entry.trades)) : [];
    } else {
        document.getElementById('todayPnL').value = '';
        document.getElementById('todayNote').value = '';
        todayTrades = [];
    }
    
    // 2. Bilder laden (NEU)
    todayScreenshots = []; // Reset
    const savedFiles = entry.screenshots || [];
    
    if (savedFiles.length > 0) {
        for (const filename of savedFiles) {
            // Bild aus IndexedDB holen
            const blob = await getImageFromDB(filename);
            if (blob) {
                // Wir pushen das Blob direkt, renderScreenshots() k√ºmmert sich um die Anzeige
                todayScreenshots.push(blob);
            } else {
                console.warn("Bild nicht gefunden:", filename);
                // Wenn Bild fehlt, zeigen wir den Dateinamen als Platzhalter (oder l√∂schen es)
                // todayScreenshots.push(filename); 
            }
        }
    }
    
    renderTodayTradesList();
    renderScreenshots(); // Bilder anzeigen
    updateDataInfo();
    updateStatus();

    // Event Listener neu setzen (unser Fix von vorhin)
    const dropzone = document.getElementById('screenshotDropzone');
    const fileInput = document.getElementById('screenshotInput');
    const previewContainer = document.getElementById('screenshotPreviews');
    
    if(dropzone && fileInput && !dropzone.classList.contains('listening')) {
        dropzone.classList.add('listening');
        dropzone.onclick = () => fileInput.click();
        fileInput.onchange = handleFileSelect;
        
        const prevent = (e) => { e.preventDefault(); e.stopPropagation(); };
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(evt => {
            dropzone.addEventListener(evt, prevent, false);
        });
        ['dragenter', 'dragover'].forEach(evt => {
            dropzone.addEventListener(evt, () => dropzone.classList.add('dragover'), false);
        });
        ['dragleave', 'drop'].forEach(evt => {
            dropzone.addEventListener(evt, () => dropzone.classList.remove('dragover'), false);
        });
        dropzone.addEventListener('drop', (e) => {
            processFiles(e.dataTransfer.files);
        }, false);
    }
}

// --- TODAY TAB FUNCTIONS ---
function switchTodayTab(tab) {
    document.querySelectorAll('.today-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.today-tab-content').forEach(c => c.classList.remove('active'));
    
    if(tab === 'simple') {
        document.querySelectorAll('.today-tab')[0].classList.add('active');
        document.getElementById('today-simple').classList.add('active');
    } else if(tab === 'trades') {
        document.querySelectorAll('.today-tab')[1].classList.add('active');
        document.getElementById('today-trades').classList.add('active');
    } else {
        document.querySelectorAll('.today-tab')[2].classList.add('active');
        document.getElementById('today-notes').classList.add('active');
    }
}

function renderTodayTradesList() {
    const list = document.getElementById('todayTradesList');
    list.innerHTML = '';
    todayTrades.forEach((t, i) => {
        // Dropdown HTML generieren
        let strategyOptions = STRATEGIES.map(s => 
            `<option value="${s.id}" ${t.tag === s.id ? 'selected' : ''}>${s.label}</option>`
        ).join('');

        const div = document.createElement('div');
        div.className = 'trade-list-item';
        div.innerHTML = `
            <div class="trade-inputs-row" style="display:flex; gap:10px;">
                <input type="number" inputmode="decimal" placeholder="PnL" value="${t.pnl}" onchange="updateTodayTrade(${i}, 'pnl', this.value)" style="border:1px solid #ced4da;border-radius:4px;padding:8px; width:100%">
            </div>
            <div class="trade-inputs-row" style="display:flex; gap:5px; margin-top:5px;">
                <select style="border:1px solid #ced4da;border-radius:4px;padding:4px; width:70%" onchange="updateTodayTrade(${i}, 'inst', this.value)">
                    <option value="ES" ${(!t.inst || t.inst==='ES')?'selected':''}>ES</option>
                    <option value="NQ" ${t.inst==='NQ'?'selected':''}>NQ</option>
                    <option value="MES" ${t.inst==='MES'?'selected':''}>MES</option>
                    <option value="Mar20" ${t.inst==='Mar20'?'selected':''}>Mar20</option>
                </select>
                <input type="number" placeholder="Anz." value="${t.qty||1}" onchange="updateTodayTrade(${i}, 'qty', this.value)" style="border:1px solid #ced4da;border-radius:4px;padding:4px; width:30%">
            </div>
            <div class="trade-inputs-row" style="display:flex; gap:5px; margin-top:5px;">
                <input type="time" style="border:1px solid #ced4da;border-radius:4px;padding:4px; width:100%" value="${t.start||''}" onchange="updateTodayTrade(${i}, 'start', this.value)">
                <input type="time" style="border:1px solid #ced4da;border-radius:4px;padding:4px; width:100%" value="${t.end||''}" onchange="updateTodayTrade(${i}, 'end', this.value)">
            </div>
            <!-- NEU: STRATEGIE TAG -->
            <select class="strategy-select" onchange="updateTodayTrade(${i}, 'tag', this.value)">
                ${strategyOptions}
            </select>
            
            <button class="btn-delete-small" onclick="removeTodayTrade(${i})">L√∂schen</button>
        `;
        list.appendChild(div);
    });
}

function addTodayTrade() { 
    todayTrades.push({ pnl: 0, start: '', end: '', inst: 'ES', qty: 1 }); 
    renderTodayTradesList(); 
}

function removeTodayTrade(i) { 
    todayTrades.splice(i, 1); 
    renderTodayTradesList(); 
    recalcTodayTotal(); 
}

function updateTodayTrade(i, field, val) { 
    if(field === 'pnl' || field === 'qty') todayTrades[i][field] = parseFloat(val) || 0; 
    else todayTrades[i][field] = val; 
    recalcTodayTotal(); 
}

function recalcTodayTotal() { 
    if(todayTrades.length > 0) { 
        const sum = todayTrades.reduce((a, b) => a + (b.pnl || 0), 0); 
        document.getElementById('todayPnL').value = sum; 
    } 
}

async function saveToday() {
    const t = new Date();
    const v = document.getElementById('todayPnL').value;
    const note = document.getElementById('todayNote').value;
    
    // Einfache Validierung
    if(!v && todayTrades.length === 0 && todayScreenshots.length === 0){
        alert('Bitte PnL, Trades oder einen Screenshot eingeben');
        return;
    }
    
    // 1. Bilder verarbeiten
    const savedFilenames = [];
    const dateStr = dk(t); // "2024-01-24"

    for (let i = 0; i < todayScreenshots.length; i++) {
        const file = todayScreenshots[i];
        
        if (file instanceof File || file instanceof Blob) {
            // Es ist eine neue Datei -> Speichern
            // Erstelle eindeutigen Namen: img_2024-01-24_1706123456_0.jpg
            const timestamp = new Date().getTime();
            const ext = file.type === 'image/png' ? 'png' : 'jpg';
            const filename = `img_${dateStr}_${timestamp}_${i}.${ext}`;
            
            try {
                await saveImageToDB(filename, file);
                savedFilenames.push(filename);
            } catch (e) {
                console.error("Bild konnte nicht gespeichert werden:", e);
                alert("Fehler beim Speichern eines Bildes!");
            }
        } else if (typeof file === 'string') {
            // Es ist schon ein Dateiname (wurde heute schon geladen) -> Behalten
            savedFilenames.push(file);
        }
    }

    // 2. Daten zusammenstellen
    const pnlVal = parseFloat(v) || 0;
    
    data[dateStr] = { 
        total: pnlVal, 
        trades: todayTrades.length > 0 ? todayTrades : [], 
        note: note,
        screenshots: savedFilenames // Hier speichern wir die Liste der Dateinamen
    };
    
    // 3. Alles speichern
    save(); // Speichert CSV/LocalStorage
    
    // UI Feedback
    const msg = document.getElementById('msg');
    msg.textContent = "Gespeichert (+ Bilder) ‚úì";
    msg.style.display='block';
    setTimeout(()=>msg.style.display='none',3000);
    
    // Aktualisieren, damit die neuen Dateinamen geladen werden
    init(); 
}

// --- NAVIGATION & SWIPE ---
const viewIds = ['today', 'calendar', 'wealth', 'statistics', 'tax', 'export'];

function showView(n){
    document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
    document.getElementById(n).classList.add('active');
    
    const btnIndex = viewIds.indexOf(n);
    if(btnIndex > -1) {
        document.querySelectorAll('.nav-btn')[btnIndex].classList.add('active');
    }

    if(n==='calendar'){
        renderCal();
    }
    else if(n==='wealth')renderWealth();
    else if(n==='statistics')renderStats();
    else if(n==='export')updateDataInfo();
    else if(n==='tax') {
        loadTaxData(); // Daten laden
        switchTaxSubView('overview'); // Ersten Unter-Tab √∂ffnen
    }
    else if(n==='today')init();
}

// Swipe Logic
let touchStartX = 0;
let touchStartY = 0;

document.addEventListener('touchstart', function(e) {
    touchStartX = e.changedTouches[0].screenX;
    touchStartY = e.changedTouches[0].screenY;
}, false);

document.addEventListener('touchend', function(e) {
    const touchEndX = e.changedTouches[0].screenX;
    const touchEndY = e.changedTouches[0].screenY;
    handleSwipe(touchStartX, touchStartY, touchEndX, touchEndY);
}, false);

function handleSwipe(sx, sy, ex, ey) {
    if(document.getElementById('day-details').classList.contains('active')) return;

    const diffX = ex - sx;
    const diffY = ey - sy;

    if (Math.abs(diffX) > 50 && Math.abs(diffY) < 50) {
        const currentViewEl = document.querySelector('.view.active');
        if(!currentViewEl) return;
        
        const currentId = currentViewEl.id;
        const currentIndex = viewIds.indexOf(currentId);
        
        if(currentIndex === -1) return;

        if (diffX < 0) {
            if (currentIndex < viewIds.length - 1) showView(viewIds[currentIndex + 1]);
        } else {
            if (currentIndex > 0) showView(viewIds[currentIndex - 1]);
        }
    }
}

function changeMonth(d){calMonth.setMonth(calMonth.getMonth()+d);renderCal()}
function changeStatsMonth(d){statsMonth.setMonth(statsMonth.getMonth()+d);renderStats()}

function renderCal(){
    const y=calMonth.getFullYear(),m=calMonth.getMonth();
    const mn=['Januar','Februar','M√§rz','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];
    document.getElementById('monthTitle').textContent=`${mn[m]} ${y}`;
    renderMonthStats(y,m);
    const fd=new Date(y,m,1),ld=new Date(y,m+1,0);
    const g=document.getElementById('calGrid');
    g.innerHTML='';

    const lastDay = new Date(y, m + 1, 0).getDate();
    let hasWeekendData = false;
    for(let d=1; d<=lastDay; d++){
        const t = new Date(y,m,d);
        if((t.getDay()===0 || t.getDay()===6) && data[dk(t)]) { hasWeekendData = true; break; }
    }

    let headers = hasWeekendData ? ['Mo','Di','Mi','Do','Fr','Sa','So'] : ['Mo','Di','Mi','Do','Fr'];
    g.style.gridTemplateColumns = `repeat(${headers.length}, 1fr)`;
    headers.forEach(h => {
        const div = document.createElement('div');
        div.className = 'calendar-header';
        div.textContent = h;
        g.appendChild(div);
    });

    const firstDayObj = new Date(y, m, 1);
    let firstDayWeekday = firstDayObj.getDay(); 
    let emptyCells = hasWeekendData ? (firstDayWeekday === 0 ? 6 : firstDayWeekday - 1) : (firstDayWeekday >= 1 && firstDayWeekday <= 5 ? firstDayWeekday - 1 : 0);

    for(let i=0;i<emptyCells;i++){
        const e=document.createElement('div');
        e.className='calendar-day empty';
        g.appendChild(e);
    }

    for(let day=1;day<=lastDay;day++){
        const dt=new Date(y,m,day);
        const dow=dt.getDay();
        const k=dk(dt);
        if(!hasWeekendData && (dow===0 || dow===6)) continue;

        const dv=document.createElement('div');
        dv.className='calendar-day';
        if((dow===0||dow===6) && !data[k]) dv.classList.add('weekend-hidden');
        

        dv.innerHTML = `<div class="day-number">${day}</div>`;
        
        if(data[k]){
            const entry = getEntry(k);
            const p = entry.total;
            dv.classList.add(p>=0?'profit':'loss');
            dv.innerHTML += `<div class="day-pnl">${p>=0?'+':''}${p.toFixed(0)}</div>`;
            if(entry.note) dv.innerHTML += `<div class="note-icon">üìù</div>`;
        } else { dv.classList.add('future'); }
        
        dv.onclick=()=>{
            const entry = getEntry(k);
            // NEUE VERSION:
// Zeige Details, wenn Trades ODER Screenshots da sind
if((entry.trades && entry.trades.length > 0) || (entry.screenshots && entry.screenshots.length > 0)) {
    renderDayDetails(dt);
} else {
    openModal(dt);
}
        };
        g.appendChild(dv);
    }
}

function renderMonthStats(y,m){
    // Sammle alle Tagesdaten f√ºr diesen Monat
    const md=Object.keys(data).filter(k=>{
        const[y2,m2]=k.split('-');
        return parseInt(y2)===y&&parseInt(m2)===m+1;
    }).sort().map(k=>{
        const entry = getEntry(k);
        const day = parseInt(k.split('-')[2]);
        return {
            day: day,
            total: entry.total,
            trades: entry.trades,
            date: k
        };
    });
    
    const t=md.reduce((s,v)=>s+v.total,0);
    const p=md.filter(v=>v.total>0).length;
    const wr=md.length>0?(p/md.length*100).toFixed(1):0;
    
    // Kalender-Statistik (oben - 3 kleine Karten)
    const calStats = document.getElementById('calStats');
    calStats.innerHTML = `
        <div class="stat-card">
            <div class="stat-label">Gesamt</div>
            <div class="stat-value ${t>=0?'profit':'loss'}">${t>=0?'+':''}${t.toFixed(0)}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Tage</div>
            <div class="stat-value">${md.length}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Win Rate</div>
            <div class="stat-value ${wr>=50?'profit':'loss'}">${Math.round(wr)}%</div>
        </div>
    `;
    
    // RENDER DIE NEUE MONATS-STATISTIK-KARTE (unten rechts)
    renderMonthStatsCard(md, y, m);
}

// NEUE FUNKTION: Rendert die gro√üe Monats-Statistik-Karte
function renderMonthStatsCard(monthData, year, month) {
    const container = document.getElementById('monthStatsContent');
    
    if (!container) {
        console.log("Container monthStatsContent nicht gefunden");
        return;
    }
    
    if (monthData.length === 0) {
        container.innerHTML = '<p style="text-align:center;color:#868e96;padding:40px;">Keine Daten f√ºr diesen Monat</p>';
        return;
    }
    
    // Berechne Brokergeb√ºhren f√ºr den Monat
    let monthFees = 0;
    let bestDay = null;
    let worstDay = null;
    
    monthData.forEach(day => {
        let dailyFee = 0;
        
        // FIX: Gespeicherte Geb√ºhren zuerst nehmen!
        const entry = getEntry(day.date); // Hilfreich um Zugriff auf fees zu haben
        
        if (entry.fees && entry.fees > 0) {
            dailyFee = entry.fees;
        } else if (day.trades && day.trades.length > 0) {
            day.trades.forEach(t => {
                dailyFee += getComm(t.inst, t.qty || 1);
            });
        }
        monthFees += dailyFee;
        
        // Bester/schlechtester Tag finden
        if (!bestDay || day.total > bestDay.total) bestDay = day;
        if (!worstDay || day.total < worstDay.total) worstDay = day;
    });
    
    const totalPnL = monthData.reduce((sum, day) => sum + day.total, 0);
    
    // HTML f√ºr die Statistik-Karte
    let html = `
        <div class="month-stats-grid">
            <div class="month-stat-card">
                <div class="month-stat-label">Bisheriges PnL</div>
                <div class="month-stat-value ${totalPnL >= 0 ? 'profit' : 'loss'}">${totalPnL >= 0 ? '+' : ''}${totalPnL.toFixed(0)}</div>
            </div>
            <div class="month-stat-card">
                <div class="month-stat-label">Brokergeb√ºhren</div>
                <div class="month-stat-value loss">-${monthFees.toFixed(2)}</div>
            </div>
            <div class="month-stat-card">
                <div class="month-stat-label">Bester Tag</div>
                <div class="month-stat-value profit">+${bestDay.total.toFixed(0)}</div>
                <div style="font-size:0.65em;color:#868e96;margin-top:2px;">${bestDay.day}.${month+1}</div>
            </div>
            <div class="month-stat-card">
                <div class="month-stat-label">Schlechtester Tag</div>
                <div class="month-stat-value loss">${worstDay.total.toFixed(0)}</div>
                <div style="font-size:0.65em;color:#868e96;margin-top:2px;">${worstDay.day}.${month+1}</div>
            </div>
        </div>
        
                <div style="margin-top:15px;">
            <div style="font-size:0.75em;color:#868e96;margin-bottom:8px;text-align:center;font-weight:300;">
                T√§gliche Performance (${monthData.length} Tage)
            </div>
                                   <div style="height: 120px; background: #fafafa; border-radius: 6px; padding: 10px; position: relative;">
                <!-- NULL-LINIE AM BODEN DES DIAGRAMMS -->
                <div style="position: absolute; bottom: 50px; left: 0; right: 0; height: 0.5px; background: #888888; text-align: center; color: white; opacity: 0.7; font-size: 0.7em; z-index: 1;">
                  
                </div>
                
                <div style="display: flex; align-items: flex-end; height: 100%; justify-content: space-around; padding-bottom: 25px;">
    `;
    
    // Balkendiagramm
    const maxAbsValue = Math.max(...monthData.map(d => Math.abs(d.total))) || 1;
    const maxBarHeight = 60;
    
    monthData.forEach(day => {
        const isProfit = day.total >= 0;
        const barHeight = (Math.abs(day.total) / maxAbsValue) * maxBarHeight;
        
        html += `
                    <div style="display: flex; flex-direction: column; align-items: center; margin: 0 2px;">
                        <div style="width: 6px; height: ${Math.max(barHeight, 2)}px; background: ${isProfit ? '#37b24d' : '#fa5252'}; border-radius: 1px;"></div>
                        <div style="font-size: 0.6em; color: #868e96; margin-top: 4px;">${day.day}</div>
                    </div>
        `;
    });
    
    html += `
                </div>
            </div>
            
            <div style="display:flex;justify-content:space-between;margin-top:8px;">
                <div style="font-size:0.65em;color:#868e96;font-weight:300;">Anfang</div>
                <div style="font-size:0.65em;color:#868e96;font-weight:300;">Ende</div>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
}

// --- DAY DETAILS VIEW (MIT KORREKTEN GEB√úHREN) ---
async function renderDayDetails(d) {
    selDate = d;
    const k = dk(d);
    const entry = getEntry(k);
    const trades = entry.trades || [];
    
    document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
    document.getElementById('day-details').classList.add('active');
    
    // --- Stats Berechnung ---
    const totalPnL = entry.total;
    const wins = trades.filter(t => t.pnl > 0).length;
    const winRate = trades.length ? ((wins / trades.length) * 100).toFixed(0) + '%' : '0%';
    const grossProfit = trades.reduce((s, t) => s + (t.pnl > 0 ? t.pnl : 0), 0);
    const grossLoss = Math.abs(trades.reduce((s, t) => s + (t.pnl < 0 ? t.pnl : 0), 0));
    const profitFactor = grossLoss > 0 ? (grossProfit / grossLoss).toFixed(2) : '‚àû';
    const avgPnL = trades.length ? (totalPnL / trades.length).toFixed(2) : 0;
    
    let totalMins = 0; let counted = 0;
    
    // --- FIX: GEB√úHREN ---
    let dayFees = 0;
    
    // 1. Priorit√§t: Gespeicherte Geb√ºhren vom Import
    if (entry.fees && entry.fees > 0) {
        dayFees = entry.fees;
    } 
    // 2. Fallback: Selbst berechnen (f√ºr alte Tage oder manuelle Eintr√§ge)
    else if (trades.length > 0) {
        trades.forEach(t => {
            dayFees += getComm(t.inst, t.qty);
        });
    }
    
    // Restliche Schleife f√ºr Dauer-Berechnung
    trades.forEach(t => {
        if(t.start && t.end) {
            const s = new Date(`2000-01-01T${t.start}`);
            const e = new Date(`2000-01-01T${t.end}`);
            let diff = (e - s) / 60000;
            if(diff < 0) diff += 1440;
            totalMins += diff; counted++;
        }
    });
    const avgHold = counted ? (totalMins / counted).toFixed(0) + ' min' : '-';

    // --- Waterfall (unver√§ndert) ---
    let waterfallHtml = '';
    // (Den Waterfall Code hier verk√ºrzt dargestellt - du kannst deinen bestehenden Block behalten oder diesen nehmen)
    if(trades.length > 0) {
        // ... (Dein Waterfall Code bleibt gleich) ...
        // Falls du den Code nicht kopieren willst, lass deinen Waterfall Block einfach drin!
        // Ich f√ºge hier nur der Vollst√§ndigkeit halber einen Platzhalter ein, 
        // nimm bitte deinen existierenden Waterfall-Code aus der alten Funktion!
        waterfallHtml = `<div class="info-box">Waterfall Chart (Code hier einf√ºgen oder bestehenden lassen)</div>`; 
        // HINWEIS: Kopiere deinen alten Waterfall-Code hier rein, ich wollte den Post nicht zu lang machen.
    }
    // Ich kopiere deinen exakten Waterfall Code hier rein, damit du Copy-Paste machen kannst:
    if(trades.length > 0) {
        let runningTotal = 0;
        let points = [{val: 0, pnl: 0}];
        trades.forEach(t => {
            const p = parseFloat(t.pnl) || 0;
            runningTotal += p;
            points.push({ val: runningTotal, pnl: p });
        });
        const maxVal = Math.max(...points.map(p => p.val));
        const minVal = Math.min(...points.map(p => p.val));
        const range = Math.max(maxVal - minVal, 10); 
        const padding = range * 0.1;
        const drawMin = minVal - padding;
        const drawMax = maxVal + padding;
        const drawRange = drawMax - drawMin;
        const zeroY = 100 - ((0 - drawMin) / drawRange) * 100;
        let svgContent = '';
        if(drawMin < 0 && drawMax > 0) {
            svgContent += `<line x1="0" y1="${zeroY}%" x2="100%" y2="${zeroY}%" stroke="#ced4da" stroke-width="1" stroke-dasharray="4" vector-effect="non-scaling-stroke" />`;
        }
        const unitWidth = 20; 
        const chartWidth = Math.max(trades.length * unitWidth, 300); 
        const barWidthPx = unitWidth * 0.8;
        const gapPx = unitWidth * 0.1;
        for(let i=0; i<trades.length; i++) {
            const startVal = points[i].val;
            const endVal = points[i+1].val;
            const pnl = points[i+1].pnl;
            const yTopVal = Math.max(startVal, endVal);
            const yBottomVal = Math.min(startVal, endVal);
            const yTop = 100 - ((yTopVal - drawMin) / drawRange) * 100;
            const yBottom = 100 - ((yBottomVal - drawMin) / drawRange) * 100;
            const height = Math.max(yBottom - yTop, 0.5); 
            const color = pnl >= 0 ? '#37b24d' : '#fa5252';
            const xPos = (i * unitWidth) + gapPx;
            svgContent += `<rect x="${xPos}" y="${yTop}%" width="${barWidthPx}" height="${height}%" fill="${color}" rx="2" />`;
            if(i < trades.length - 1) {
                const nextY = 100 - ((endVal - drawMin) / drawRange) * 100;
                const lineX1 = xPos + barWidthPx;
                const lineX2 = ((i+1) * unitWidth) + gapPx;
                svgContent += `<line x1="${lineX1}" y1="${nextY}%" x2="${lineX2}" y2="${nextY}%" stroke="#adb5bd" stroke-width="1" vector-effect="non-scaling-stroke" />`;
            }
        }
        waterfallHtml = `<div class="waterfall-container"><div class="chart-title">Intraday Verlauf</div><div class="waterfall-chart"><svg style="width: ${chartWidth}px; min-width: 100%;" preserveAspectRatio="none">${svgContent}</svg></div></div>`;
    }


    // --- BILDER LADEN (NEU) ---
    let screenshotsHtml = '';
    if (entry.screenshots && entry.screenshots.length > 0) {
        screenshotsHtml = `<div class="chart-container"><div class="chart-title">üì∏ Screenshots</div><div class="preview-grid" id="detailScreenshots">Lade Bilder...</div></div>`;
    }

    // --- HTML ZUSAMMENBAUEN ---
    const content = document.getElementById('dayDetailContent');
    content.innerHTML = `
        <div class="day-detail-header">
            <h3>${fd(d)}</h3>
            <div class="day-detail-total ${totalPnL>=0?'profit':'loss'}">${totalPnL>=0?'+':''}${totalPnL.toFixed(2)}</div>
        </div>
        <div class="day-detail-grid">
            <div class="detail-card"><div class="detail-label">Win Rate</div><div class="detail-value">${winRate}</div></div>
            <div class="detail-card"><div class="detail-label">Profit Factor</div><div class="detail-value">${profitFactor}</div></div>
            <div class="detail-card"><div class="detail-label">√ò PnL</div><div class="detail-value ${avgPnL>=0?'profit':'loss'}">${avgPnL}</div></div>
            <div class="detail-card"><div class="detail-label">√ò Hold</div><div class="detail-value">${avgHold}</div></div>
            <div class="detail-card"><div class="detail-label">Geb√ºhren</div><div class="detail-value loss">-${dayFees.toFixed(2)}</div></div>
        </div>
        ${waterfallHtml}
        
        <!-- TRADES LISTE (jetzt oben) -->
        <div class="chart-container">
            <div class="chart-title">Trades (${trades.length})</div>
            <div id="dayTradesList"></div>
        </div>

        <!-- NOTIZ -->
        ${entry.note ? `<div class="info-box"><strong>üìù Notiz:</strong><br>${entry.note}</div>` : ''}
        
        <!-- SCREENSHOTS (jetzt ganz unten) -->
        ${screenshotsHtml}
    `;

    // --- TRADES LISTE RENDERN ---
    const list = document.getElementById('dayTradesList');
    const maxAbs = Math.max(...trades.map(t => Math.abs(t.pnl))) || 1;
    
    trades.forEach(t => {
        // Strategie Label finden
        const strat = STRATEGIES.find(s => s.id === t.tag);
        const stratLabel = strat && strat.id !== '' ? `<div style="font-size:0.7em;color:#666;margin-top:2px;font-style:italic;">${strat.label}</div>` : '';

        let durationStr = "-";
        if(t.start && t.end) {
            const s = new Date(`2000-01-01T${t.start}`);
            const e = new Date(`2000-01-01T${t.end}`);
            let diff = (e - s) / 60000;
            if(diff < 0) diff += 1440;
            durationStr = diff + " min";
        }
        const widthPct = Math.max((Math.abs(t.pnl) / maxAbs) * 100, 1);
        const row = document.createElement('div');
        row.className = 'trade-row';
        row.innerHTML = `
            <div class="trade-time">
                <strong>${t.start || '--:--'}</strong>
                <span>${durationStr}</span>
                ${stratLabel} <!-- HIER IST DAS LABEL -->
            </div>
            <div class="trade-bar-container"><div class="trade-bar-fill ${t.pnl>=0?'profit':'loss'}" style="width: ${widthPct}%"></div></div>
            <div class="trade-pnl ${t.pnl>=0?'profit':'loss'}">${t.pnl>=0?'+':''}${t.pnl.toFixed(0)}</div>
        `;
        list.appendChild(row);
    });

    // --- BILDER NACHLADEN (NEU) ---
    if (entry.screenshots && entry.screenshots.length > 0) {
        const imgContainer = document.getElementById('detailScreenshots');
        imgContainer.innerHTML = ''; // "Lade Bilder..." entfernen
        
        for (const filename of entry.screenshots) {
            const blob = await getImageFromDB(filename);
            if (blob) {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(blob);
                
                // Styles direkt setzen (Stabilit√§t!)
                const div = document.createElement('div');
                div.className = 'preview-item';
                div.style.width = '100px';
                div.style.height = '100px';
                div.style.position = 'relative';
                div.style.overflow = 'hidden';
                div.style.borderRadius = '8px';
                div.style.border = '1px solid #e9ecef';
                div.style.flexShrink = '0';
                
                img.style.width = '100%';
                img.style.height = '100%';
                img.style.objectFit = 'cover';
                img.style.cursor = 'pointer';
                
                // Doppelklick zum Vergr√∂√üern
                img.ondblclick = () => {
                    const newTab = window.open();
                    if(newTab) newTab.document.write(`<html><body style="margin:0;background:#222;display:flex;justify-content:center;align-items:center;height:100vh;"><img src="${img.src}" style="max-width:100%;max-height:100%"></body></html>`);
                };
                
                div.appendChild(img);
                imgContainer.appendChild(div);
                addHoverPreview(div, img.src);
            }
        }
    }
}

function editCurrentDay() { if(selDate) openModal(selDate); }

// WICHTIG: async hinzuf√ºgen!
async function openModal(d){
    selDate = d;
    const k = dk(d);
    const entry = getEntry(k);
    
    document.getElementById('modalTitle').textContent = fd(d);
    document.getElementById('modalPnL').value = entry.total !== 0 ? entry.total : '';
    document.getElementById('modalNote').value = entry.note;
    
    currentTrades = entry.trades ? JSON.parse(JSON.stringify(entry.trades)) : [];
    renderTradesList();
    
    // --- BILDER LADEN (NEU) ---
    currentModalScreenshots = [];
    const savedFiles = entry.screenshots || [];
    
    // Bestehende Bilder aus DB holen
    if (savedFiles.length > 0) {
        for (const filename of savedFiles) {
            const blob = await getImageFromDB(filename);
            if (blob) currentModalScreenshots.push(blob);
        }
    }
    renderModalScreenshots(); // Anzeigen
    
    // --- EVENT LISTENER SETZEN (NEU - Damit Klick & Drag funktioniert) ---
    const dropzone = document.getElementById('modalScreenshotDropzone');
    const input = document.getElementById('modalScreenshotInput');
    
    if(dropzone && input) {
        // Klick aktivieren
        dropzone.onclick = () => input.click();
        input.onchange = handleModalFileSelect;
        
        // Drag & Drop aktivieren
        const prevent = (e) => { e.preventDefault(); e.stopPropagation(); };
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(evt => {
            dropzone.addEventListener(evt, prevent, false);
        });
        
        // Visuelles Feedback
        ['dragenter', 'dragover'].forEach(evt => {
            dropzone.addEventListener(evt, () => dropzone.classList.add('dragover'), false);
        });
        ['dragleave', 'drop'].forEach(evt => {
            dropzone.addEventListener(evt, () => dropzone.classList.remove('dragover'), false);
        });
        
        // Drop Aktion
        dropzone.ondrop = (e) => {
            e.preventDefault();
            processModalFiles(e.dataTransfer.files);
        };
    }

    document.getElementById('delBtn').style.display = data[k] ? 'block' : 'none';
    
    switchModalTab('simple');
    document.getElementById('modal').classList.add('active');
}

function switchModalTab(tab) {
    document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.modal-tab')[tab==='simple'?0:tab==='trades'?1:2].classList.add('active');
    document.getElementById('tab-simple').style.display = tab==='simple'?'block':'none';
    document.getElementById('tab-trades').style.display = tab==='trades'?'block':'none';
    document.getElementById('tab-notes').style.display = tab==='notes'?'block':'none';
}

function renderTradesList() {
    const list = document.getElementById('tradesList');
    list.innerHTML = '';
    currentTrades.forEach((t, i) => {
        let strategyOptions = STRATEGIES.map(s => 
            `<option value="${s.id}" ${t.tag === s.id ? 'selected' : ''}>${s.label}</option>`
        ).join('');

        const div = document.createElement('div');
        div.className = 'trade-list-item';
        div.innerHTML = `
            <div class="trade-inputs-row" style="display:flex; gap:10px;">
                <input type="number" inputmode="decimal" placeholder="PnL" value="${t.pnl}" onchange="updateTrade(${i}, 'pnl', this.value)" style="border:1px solid #ced4da;border-radius:4px;padding:8px; width:100%">
            </div>
            <div class="trade-inputs-row" style="display:flex; gap:5px; margin-top:5px;">
                <select style="border:1px solid #ced4da;border-radius:4px;padding:4px; width:70%" onchange="updateTrade(${i}, 'inst', this.value)">
                    <option value="ES" ${(!t.inst || t.inst==='ES')?'selected':''}>ES</option>
                    <option value="NQ" ${t.inst==='NQ'?'selected':''}>NQ</option>
                    <option value="MES" ${t.inst==='MES'?'selected':''}>MES</option>
                    <option value="Mar20" ${t.inst==='Mar20'?'selected':''}>Mar20</option>
                </select>
                <input type="number" placeholder="Anz." value="${t.qty||1}" onchange="updateTrade(${i}, 'qty', this.value)" style="border:1px solid #ced4da;border-radius:4px;padding:4px; width:30%">
            </div>
            <div class="trade-inputs-row" style="display:flex; gap:5px; margin-top:5px;">
                <input type="time" style="border:1px solid #ced4da;border-radius:4px;padding:4px; width:100%" value="${t.start||''}" onchange="updateTrade(${i}, 'start', this.value)">
                <input type="time" style="border:1px solid #ced4da;border-radius:4px;padding:4px; width:100%" value="${t.end||''}" onchange="updateTrade(${i}, 'end', this.value)">
            </div>
            
            <!-- NEU: STRATEGIE TAG -->
            <select class="strategy-select" onchange="updateTrade(${i}, 'tag', this.value)">
                ${strategyOptions}
            </select>
            
            <button class="btn-delete-small" onclick="removeTrade(${i})">L√∂schen</button>
        `;
        list.appendChild(div);
    });
}

function addTradeRow() { currentTrades.push({ pnl: 0, start: '', end: '', inst: 'ES', qty: 1 }); renderTradesList(); }
function removeTrade(i) { currentTrades.splice(i, 1); renderTradesList(); recalcTotalFromTrades(); }
function updateTrade(i, field, val) { 
    if(field === 'pnl' || field === 'qty') currentTrades[i][field] = parseFloat(val) || 0; 
    else currentTrades[i][field] = val; 
    recalcTotalFromTrades(); 
}
function recalcTotalFromTrades() { if(currentTrades.length > 0) { const sum = currentTrades.reduce((a, b) => a + (b.pnl || 0), 0); document.getElementById('modalPnL').value = sum; } }

// WICHTIG: async davor schreiben!
async function saveModal(){
    if(!selDate) return;
    const k = dk(selDate); // Das Datum, z.B. "2026-01-24"
    
    // Werte aus den Feldern holen
    const pnlVal = parseFloat(document.getElementById('modalPnL').value) || 0;
    const note = document.getElementById('modalNote').value;
    
    // --- BILDER SPEICHERN ---
    const savedFilenames = [];
    
    // Wir gehen alle Bilder durch, die gerade in der Box sind
    for (let i = 0; i < currentModalScreenshots.length; i++) {
        const file = currentModalScreenshots[i];
        
        // Wir erstellen f√ºr jedes Bild einen neuen, eindeutigen Namen
        // (img_DATUM_ZEITSTEMPEL_NUMMER.jpg)
        const timestamp = new Date().getTime();
        let ext = 'jpg';
        if(file.type === 'image/png') ext = 'png';
        
        const filename = `img_${k}_${timestamp}_${i}.${ext}`;
        
        try {
            // Ab in die Datenbank damit!
            await saveImageToDB(filename, file);
            // Namen merken f√ºr die CSV
            savedFilenames.push(filename);
        } catch (e) {
            console.error("Fehler beim Speichern:", e);
        }
    }
    
    // Daten aktualisieren
    data[k] = { 
        total: pnlVal, 
        trades: currentTrades, 
        note: note,
        screenshots: savedFilenames // Die Liste der Dateinamen
    };
    
    // Speichern & Schlie√üen
    save();
    closeModal();
    
    // Ansicht aktualisieren
    // Falls wir gerade in der Detail-Ansicht sind -> neu laden
    if(document.getElementById('day-details').classList.contains('active')) {
        renderDayDetails(selDate); 
    } else {
        // Falls wir im Kalender sind -> Kalender neu malen
        renderCal();
    }
    
    // Falls wir zuf√§llig "Heute" bearbeitet haben, auch den Heute-Tab aktualisieren
    if(dk(new Date()) === k) init();
}

function closeModal(){
    clearAllPreviews(); // <--- ZWANGS-L√ñSCHUNG
    document.getElementById('modal').classList.remove('active');
    if(!document.getElementById('day-details').classList.contains('active')) selDate = null;
}

function deleteEntry(){
    if(!selDate) return;
    delete data[dk(selDate)];
    save();
    closeModal();
    showView('calendar');
    if(dk(new Date()) === dk(selDate)) init();
}

// --- CHART ENGINE ---
function drawLineChart(containerId, entries, cumulativeTotal) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    container.style.position = 'relative';

    if(entries.length === 0) { container.innerHTML = '<p style="text-align:center;padding:50px;color:#868e96">Keine Daten</p>'; return; }

    let runningCum = 0;
    const points = entries.map(e => { runningCum += e.v; return { k: e.k, c: runningCum }; });
    const maxC = Math.max(...points.map(p => p.c));
    const minC = Math.min(...points.map(p => p.c));
    const range = Math.max(maxC - minC, 1);

    const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
    svg.setAttribute('viewBox','0 0 100 100');
    svg.setAttribute('preserveAspectRatio','none');
    svg.style.width = '100%'; svg.style.height = '100%'; svg.style.position = 'absolute'; svg.style.left = '0'; svg.style.top = '0';

    if(minC < 0 && maxC > 0) {
        const zy = 100 - ((0 - minC) / range) * 100;
        const zl = document.createElementNS('http://www.w3.org/2000/svg','line');
        zl.setAttribute('x1','0'); zl.setAttribute('y1',zy); zl.setAttribute('x2','100'); zl.setAttribute('y2',zy);
        zl.setAttribute('stroke','#ced4da'); zl.setAttribute('stroke-width','0.5'); zl.setAttribute('stroke-dasharray','2');
        zl.setAttribute('vector-effect','non-scaling-stroke');
        svg.appendChild(zl);
    }

    let pathD = '';
    points.forEach((p, i) => {
        const x = ((i / (points.length - 1 || 1)) * 100).toFixed(2);
        const y = (100 - ((p.c - minC) / range) * 100).toFixed(2);
        pathD += `${i === 0 ? 'M' : 'L'}${x},${y} `;
    });

    const path = document.createElementNS('http://www.w3.org/2000/svg','path');
    path.setAttribute('d', pathD); path.setAttribute('fill', 'none');
    path.setAttribute('stroke', cumulativeTotal >= 0 ? '#37b24d' : '#fa5252');
    path.setAttribute('stroke-width', '2'); path.setAttribute('vector-effect', 'non-scaling-stroke');
    svg.appendChild(path);
    container.appendChild(svg);

    const createLabel = (text, cssObj) => {
        const el = document.createElement('div');
        el.textContent = text;
        Object.assign(el.style, { position: 'absolute', fontSize: '0.7em', color: '#6c757d', fontWeight: '600', pointerEvents: 'none', fontFamily: 'sans-serif', ...cssObj });
        return el;
    };

    container.appendChild(createLabel(maxC.toFixed(0), { top: '2px', left: '5px' }));
    container.appendChild(createLabel(minC.toFixed(0), { bottom: '20px', left: '5px' }));
    const firstDate = entries[0].k.split('-');
    const lastDate = entries[entries.length-1].k.split('-');
    container.appendChild(createLabel(`${firstDate[2]}.${firstDate[1]}`, { bottom: '2px', left: '5px' }));
    container.appendChild(createLabel(`${lastDate[2]}.${lastDate[1]}`, { bottom: '2px', right: '5px' }));

    const valDiv = document.createElement('div');
    valDiv.style = `position:absolute;top:5px;right:10px;font-size:1em;font-weight:700;color:${cumulativeTotal >= 0 ? '#37b24d' : '#fa5252'}`;
    valDiv.textContent = (cumulativeTotal >= 0 ? '+' : '') + cumulativeTotal.toFixed(0);
    container.appendChild(valDiv);
}

function renderWealth(){
    const allEntries = Object.keys(data).sort().map(k => ({ k: k, v: getEntry(k).total }));
    const totalWealth = allEntries.reduce((s, e) => s + e.v, 0);
    drawLineChart('wealthChart', allEntries, totalWealth);
    const ms = document.getElementById('monthSummaries'); 
    ms.innerHTML = '';
    const monthMap = {};
    allEntries.forEach(e => {
        const [y, m] = e.k.split('-'); const key = `${y}-${m}`;
        if (!monthMap[key]) monthMap[key] = { pnl: 0, days: 0, wins: 0 };
        monthMap[key].pnl += e.v; monthMap[key].days++; if (e.v > 0) monthMap[key].wins++;
    });
    Object.keys(monthMap).sort().reverse().forEach(mk => {
        const [y, m] = mk.split('-');
        const mn = ['Jan','Feb','M√§r','Apr','Mai','Jun','Jul','Aug','Sep','Okt','Nov','Dez'];
        const md = monthMap[mk];
        const div = document.createElement('div');
        div.className = `month-summary ${md.pnl >= 0 ? 'profit' : 'loss'}`;
        div.style.cursor = 'pointer';
        div.onclick = () => {
            statsMonth = new Date(parseInt(y), parseInt(m)-1, 1);
            showView('statistics');
        };
        div.innerHTML = `<div class="month-summary-left"><div class="month-summary-title">${mn[parseInt(m)-1]} ${y}</div><div class="month-summary-subtitle">${md.days} Tage</div></div><div class="month-summary-value ${md.pnl >= 0 ? 'profit' : 'loss'}">${md.pnl.toFixed(2)}</div>`;
        ms.appendChild(div);
    });
}

function renderStats(){
    const y=statsMonth.getFullYear(),m=statsMonth.getMonth();
    const mn=['Jan','Feb','M√§r','Apr','Mai','Jun','Jul','Aug','Sep','Okt','Nov','Dez'];
    document.getElementById('statsTitle').textContent=`${mn[m]} ${y}`;
    
    // --- FIX: LIFETIME FEES BERECHNUNG ---
    let lifetimeFees = 0;
    Object.values(data).forEach(entry => {
        // Priorit√§t: Gespeicherte Geb√ºhren (vom Import)
        if (entry.fees && entry.fees > 0) {
            lifetimeFees += entry.fees;
        } 
        // Fallback: Wenn keine Fees gespeichert sind, berechnen wir sie aus den Trades
        else if (entry.trades) {
            entry.trades.forEach(t => lifetimeFees += getComm(t.inst, t.qty));
        }
    });
    document.getElementById('lifetimeFees').textContent = '-' + lifetimeFees.toFixed(2);

    const me=Object.keys(data).filter(k=>{
        const[y2,m2]=k.split('-'); return parseInt(y2)===y&&parseInt(m2)===m+1;
    }).sort().map(k=>({d:parseInt(k.split('-')[2]), v:getEntry(k).total, k:k, entry:getEntry(k)}));
    
    // --- FIX: MONATS FEES & CHART ---
    let monthFees = 0;
    const feeChartData = [];
    me.forEach(dayObj => {
        let dailyFee = 0;
        
        // Priorit√§t: Gespeicherte Geb√ºhren
        if (dayObj.entry.fees && dayObj.entry.fees > 0) {
            dailyFee = dayObj.entry.fees;
        } 
        // Fallback: Berechnen
        else if (dayObj.entry.trades) {
            dayObj.entry.trades.forEach(t => dailyFee += getComm(t.inst, t.qty));
        }
        
        monthFees += dailyFee;
        if(dailyFee > 0) feeChartData.push({ day: dayObj.d, fee: dailyFee });
    });
    document.getElementById('monthFees').textContent = '-' + monthFees.toFixed(2);
    
    // ... (AB HIER BLEIBT DER REST DER FUNKTION GLEICH: const fc = ...)
    const fc = document.getElementById('feeBarChart'); fc.innerHTML = '';
    if(feeChartData.length) {
        const maxFee = Math.max(...feeChartData.map(d => d.fee));
        feeChartData.forEach(d => {
             const h = Math.max((d.fee / maxFee) * 150, 2);
             const div = document.createElement('div'); div.className='bar-wrapper';
             div.innerHTML=`<div class="bar fee" style="height:${h}px"></div><div class="bar-label">${d.day}</div><div class="bar-value">${d.fee.toFixed(0)}</div>`;
             fc.appendChild(div);
        });
    } else { fc.innerHTML = '<p style="text-align:center;color:#868e96;padding:50px">Keine Geb√ºhren</p>'; }

    const md=me.map(e=>e.v), w=md.filter(v=>v>0), l=md.filter(v=>v<0);
    const t=md.reduce((s,v)=>s+v,0), p=w.length, lc=l.length;
    
    document.getElementById('statsOverview').innerHTML=`<div class="stat-card"><div class="stat-label">Gesamt</div><div class="stat-value ${t>=0?'profit':'loss'}">${t.toFixed(0)}</div></div><div class="stat-card"><div class="stat-label">Tage</div><div class="stat-value">${md.length}</div></div><div class="stat-card"><div class="stat-label">Win Rate</div><div class="stat-value">${md.length?(p/md.length*100).toFixed(0):0}%</div></div>`;

    const monthEntries = me.map(x => ({k: x.k, v: x.v}));
    drawLineChart('lineChart', monthEntries, t);

    const bc=document.getElementById('barChart'); bc.innerHTML='';
    if(me.length){
        const maxVal=Math.max(...md.map(Math.abs));
        me.forEach(e=>{
            const h=Math.max((Math.abs(e.v)/maxVal)*150, 2);
            const d=document.createElement('div'); d.className='bar-wrapper';
            d.innerHTML=`<div class="bar ${e.v>=0?'profit':'loss'}" style="height:${h}px"></div><div class="bar-label">${e.d}</div>`;
            bc.appendChild(d);
        });
    } else { bc.innerHTML='<p style="text-align:center;color:#868e96;padding:50px">Keine Daten</p>'; }

    const tcWrapper = document.getElementById('tradeChartWrapper');
    tcWrapper.innerHTML = '';
    const tStatsRow = document.getElementById('tradeStatsRow');
    let allTrades = [];
    me.forEach(dayObj => {
        if (dayObj.entry.trades && dayObj.entry.trades.length > 0) {
            dayObj.entry.trades.forEach(t => allTrades.push({ day: dayObj.d, pnl: parseFloat(t.pnl) || 0 }));
        } else if (dayObj.entry.total !== 0) {
            allTrades.push({ day: dayObj.d, pnl: parseFloat(dayObj.entry.total) });
        }
    });

    if (allTrades.length > 0) {
        const container = document.createElement('div');
        container.className = 'trade-chart-container';
        
        const maxP = Math.max(...allTrades.map(t => t.pnl));
        const minP = Math.min(...allTrades.map(t => t.pnl));
        const absMax = Math.max(Math.abs(maxP), Math.abs(minP)) || 1;
        
        const zLine = document.createElement('div');
        zLine.className = 'zero-line';
        container.appendChild(zLine);

        allTrades.forEach(t => {
            const wrapper = document.createElement('div');
            wrapper.className = 'trade-bar-wrapper';
            const pct = (Math.abs(t.pnl) / absMax) * 45; 
            const line = document.createElement('div');
            line.className = `trade-bar-line ${t.pnl >= 0 ? 'profit' : 'loss'}`;
            line.style.height = `${Math.max(pct, 1)}%`;
            if(t.pnl >= 0) { line.style.bottom = '50%'; } else { line.style.top = '50%'; }
            wrapper.appendChild(line);
            container.appendChild(wrapper);
        });
        tcWrapper.appendChild(container);

        const wins = allTrades.filter(t => t.pnl > 0);
        const losses = allTrades.filter(t => t.pnl < 0);
        const grossWin = wins.reduce((s, t) => s + t.pnl, 0);
        const grossLoss = Math.abs(losses.reduce((s, t) => s + t.pnl, 0));
        const pf = grossLoss > 0 ? (grossWin / grossLoss).toFixed(2) : '‚àû';
        const wr = ((wins.length / allTrades.length) * 100).toFixed(0);
        tStatsRow.innerHTML = `<span><strong>T:</strong> ${allTrades.length}</span><span><strong>WR:</strong> <span style="color:${wr>=50?'#37b24d':'#fa5252'}">${wr}%</span></span><span><strong>PF:</strong> ${pf}</span>`;
    } else {
        tcWrapper.innerHTML = '<p style="text-align:center;color:#868e96;padding:50px">Keine Trades</p>';
        tStatsRow.innerHTML = '';
    }

    const wdChart = document.getElementById('weekdayChart'); wdChart.innerHTML='';
    const daysStats = {0:{s:0,c:0},1:{s:0,c:0},2:{s:0,c:0},3:{s:0,c:0},4:{s:0,c:0},5:{s:0,c:0},6:{s:0,c:0}};
    Object.keys(data).forEach(k=>{
        const dt = new Date(k); const day = dt.getDay(); const val = getEntry(k).total;
        daysStats[day].s += val; daysStats[day].c++;
    });
    const labels=['So','Mo','Di','Mi','Do','Fr','Sa'];
    const order=[1,2,3,4,5,6,0];
    const avgs = order.map(i => daysStats[i].c ? daysStats[i].s/daysStats[i].c : 0);
    const maxAvg = Math.max(...avgs.map(Math.abs));
    order.forEach((i, idx)=>{
        const avg = avgs[idx];
        const h = maxAvg ? (Math.abs(avg)/maxAvg)*100 : 0;
        const col = document.createElement('div'); col.className='bar-wrapper'; col.style.flex='1';
        col.innerHTML=`<div class="bar-value">${avg.toFixed(0)}</div><div class="bar ${avg>=0?'profit':'loss'}" style="height:${Math.max(h,2)}px"></div><div class="bar-label">${labels[i]}</div>`;
        wdChart.appendChild(col);
    });

    let peak = -Infinity, maxDD = 0, currCum = 0;
    Object.keys(data).sort().forEach(k => {
        currCum += getEntry(k).total;
        if(currCum > peak) peak = currCum;
        const dd = currCum - peak;
        if(dd < maxDD) maxDD = dd;
    });

    let totalMins=0, countTrades=0;
    me.forEach(day => {
        if(day.entry.trades) {
            day.entry.trades.forEach(t => {
                if(t.start && t.end) {
                    const s = new Date(`2000-01-01T${t.start}`);
                    const e = new Date(`2000-01-01T${t.end}`);
                    let diff = (e - s) / 60000; 
                    if(diff < 0) diff += 1440; 
                    totalMins += diff; countTrades++;
                }
            });
        }
    });
    const avgHold = countTrades ? (totalMins/countTrades).toFixed(0) + ' min' : '-';

    let mws=0, mls=0, cws=0, cls=0;
    Object.keys(data).sort().forEach(k => {
        const v = getEntry(k).total;
        if(v > 0) { cws++; cls=0; mws=Math.max(mws, cws); }
        else if(v < 0) { cls++; cws=0; mls=Math.max(mls, cls); }
    });

    document.getElementById('streak').innerHTML=`<div class="stat-row"><span class="stat-row-label">Win Streak</span><span class="stat-row-value profit">${mws}</span></div><div class="stat-row"><span class="stat-row-label">Loss Streak</span><span class="stat-row-value loss">${mls}</span></div><div class="stat-row"><span class="stat-row-label">Gewinn Tage</span><span class="stat-row-value">${p}</span></div><div class="stat-row"><span class="stat-row-label">Verlust Tage</span><span class="stat-row-value">${lc}</span></div>`;
    document.getElementById('perf').innerHTML=`<div class="stat-row"><span class="stat-row-label">Max Drawdown</span><span class="stat-row-value loss">${maxDD.toFixed(2)}</span></div><div class="stat-row"><span class="stat-row-label">Max Gewinn</span><span class="stat-row-value profit">${w.length?Math.max(...w).toFixed(2):0}</span></div><div class="stat-row"><span class="stat-row-label">Max Verlust</span><span class="stat-row-value loss">${l.length?Math.min(...l).toFixed(2):0}</span></div>`;
    document.getElementById('insights').innerHTML=`<div class="stat-row"><span class="stat-row-label">√ò PnL/Trade</span><span class="stat-row-value" style="color:${t/md.length>=0?'#37b24d':'#fa5252'}">${md.length?(t/md.length).toFixed(2):0}</span></div><div class="stat-row"><span class="stat-row-label">√ò Holding Time</span><span class="stat-row-value">${avgHold}</span></div><div class="stat-row"><span class="stat-row-label">Profit Factor</span><span class="stat-row-value">${Math.abs(l.reduce((a,b)=>a+b,0))?(w.reduce((a,b)=>a+b,0)/Math.abs(l.reduce((a,b)=>a+b,0))).toFixed(2):'‚àû'}</span></div>`;
    
    // Strategie Stats (bleibt gleich)
    const stratStats = {};
    STRATEGIES.forEach(s => { if(s.id) stratStats[s.id] = { pnl: 0, wins: 0, count: 0, label: s.label }; });
    Object.values(data).forEach(day => {
        if(day.trades) {
            day.trades.forEach(t => {
                if(t.tag && stratStats[t.tag]) {
                    stratStats[t.tag].pnl += (t.pnl || 0);
                    stratStats[t.tag].count++;
                    if((t.pnl || 0) > 0) stratStats[t.tag].wins++;
                }
            });
        }
    });
    let stratHTML = '<table style="width:100%;font-size:0.85em;border-collapse:collapse;">';
    stratHTML += '<tr style="border-bottom:1px solid #eee;text-align:left;"><th style="padding:4px">Strategie</th><th style="text-align:right">#</th><th style="text-align:right">Win%</th><th style="text-align:right">PnL</th></tr>';
    const sortedStrats = Object.values(stratStats).sort((a,b) => b.pnl - a.pnl);
    sortedStrats.forEach(s => {
        if(s.count === 0) return; 
        const wr = ((s.wins / s.count) * 100).toFixed(0);
        stratHTML += `<tr style="border-bottom:1px solid #f8f9fa;"><td style="padding:8px 4px;">${s.label}</td><td style="text-align:right;font-weight:600;">${s.count}</td><td style="text-align:right;color:${wr>=50?'#37b24d':'#fa5252'}">${wr}%</td><td style="text-align:right;font-weight:700;color:${s.pnl>=0?'#37b24d':'#fa5252'}">${s.pnl.toFixed(0)}</td></tr>`;
    });
    stratHTML += '</table>';
    const stEl = document.getElementById('strategyStats');
    if(stEl) {
        if(sortedStrats.filter(s=>s.count>0).length === 0) stEl.innerHTML = '<p style="text-align:center;color:#ccc;padding:10px;">Noch keine Tags gesetzt</p>';
        else stEl.innerHTML = stratHTML;
    }
}

// **UPDATED: ASYNC EXPORT WITH DIRECT FILE ACCESS (Desktop only)**
async function exportCSV() {
    // 1. Header erweitern um "Screenshots"
    let csv = '\uFEFFDatum,PnL,Notiz,Details_JSON,Screenshots\n';
    
    Object.keys(data).sort().forEach(k => {
        const [y, m, d] = k.split('-');
        const entry = getEntry(k);
        
        const note = (entry.note || "").replace(/"/g, '""');
        const json = JSON.stringify(entry.trades || []).replace(/"/g, '""');
        // NEU: Screenshots Liste als JSON String
        const screens = JSON.stringify(entry.screenshots || []).replace(/"/g, '""');
        
        const total = (entry.total || 0).toFixed(2);
        
        // 2. Zeile schreiben mit 5. Spalte
        csv += `${d}.${m}.${y},${total},"${note}","${json}","${screens}"\n`;
    });

    const filename = `pnl_${new Date().toISOString().slice(0, 10)}.csv`;

    // ... (Rest bleibt gleich, hier nur der Speicher-Teil) ...
    if (cachedDirHandle) {
        try {
            const opts = { mode: 'readwrite' };
            if ((await cachedDirHandle.queryPermission(opts)) !== 'granted') {
                if ((await cachedDirHandle.requestPermission(opts)) !== 'granted') throw new Error('Permission denied');
            }
            const fileHandle = await cachedDirHandle.getFileHandle(filename, { create: true });
            const writable = await fileHandle.createWritable();
            await writable.write(csv);
            await writable.close();
            alert(`‚úÖ Gespeichert im Backup-Ordner:\n${filename}`);
            return;
        } catch (e) { console.warn("Fallback...", e); }
    }

    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    setTimeout(() => URL.revokeObjectURL(url), 100);
}
// --- ZIP EXPORT LOGIC ---
async function exportZIP() {
    // 1. Button Feedback geben (dauert bei vielen Bildern kurz)
    const btn = document.querySelector('button[onclick="exportZIP()"]');
    const oldText = btn ? btn.textContent : "Export";
    if(btn) {
        btn.textContent = "‚è≥ Erstelle ZIP... (bitte warten)";
        btn.disabled = true;
        btn.style.opacity = "0.7";
    }

    try {
        const zip = new JSZip();

        // --- TEIL A: CSV ERSTELLEN ---
        let csv = '\uFEFFDatum,PnL,Notiz,Details_JSON,Screenshots\n';
        
        // Wir sortieren die Daten, damit die CSV sch√∂n chronologisch ist
        const keys = Object.keys(data).sort();
        
        for (const k of keys) {
            const [y, m, d] = k.split('-');
            const entry = getEntry(k);
            
            const note = (entry.note || "").replace(/"/g, '""');
            const json = JSON.stringify(entry.trades || []).replace(/"/g, '""');
            const screens = JSON.stringify(entry.screenshots || []).replace(/"/g, '""');
            const total = (entry.total || 0).toFixed(2);
            
            csv += `${d}.${m}.${y},${total},"${note}","${json}","${screens}"\n`;
        }
        
        // CSV in das ZIP legen
        zip.file("pnl_data.csv", csv);

        // --- TEIL B: BILDER HINZUF√úGEN ---
        const imgFolder = zip.folder("screenshots");
        let imgCount = 0;

        for (const k of keys) {
            const entry = data[k];
            // Wenn der Eintrag Screenshots hat...
            if (entry.screenshots && entry.screenshots.length > 0) {
                for (const filename of entry.screenshots) {
                    // ... holen wir das Blob aus der Datenbank
                    const blob = await getImageFromDB(filename);
                    if (blob) {
                        // ... und packen es in den screenshots/ Ordner im ZIP
                        imgFolder.file(filename, blob);
                        imgCount++;
                    }
                }
            }
        }

        // --- TEIL C: ZIP GENERIEREN & DOWNLOAD ---
        // Generiert die ZIP Datei als Blob
        const zipContent = await zip.generateAsync({type:"blob"});
        
        // Download ausl√∂sen
        const url = URL.createObjectURL(zipContent);
        const a = document.createElement('a');
        a.href = url;
        const dateStr = new Date().toISOString().slice(0, 10);
        a.download = `trade_backup_${dateStr}.zip`; // Name: trade_backup_2024-01-24.zip
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        setTimeout(() => URL.revokeObjectURL(url), 100);

        // Erfolgsmeldung
        alert(`‚úÖ Backup erfolgreich!\nEnth√§lt CSV und ${imgCount} Bilder.`);

    } catch (e) {
        console.error(e);
        alert("Fehler beim ZIP Export: " + e.message);
    } finally {
        // Button zur√ºcksetzen
        if(btn) {
            btn.textContent = oldText;
            btn.disabled = false;
            btn.style.opacity = "1";
        }
    }
}

// ===========================================
// === SICHERE IMPORT LOGIK (NEU) ===
// ===========================================

// --- SICHERE MERGE LOGIK ---
function mergeData(newData) {
    let count = 0;
    
    for (const k in newData) {
        const newEntry = newData[k];
        const oldEntry = data[k];

        if (!oldEntry) {
            // Tag existiert noch nicht -> Neu anlegen
            data[k] = newEntry;
        } else {
            // Tag existiert schon -> Vorsichtig zusammenf√ºgen
            
            // 1. PnL & Trades √ºbernehmen (IBKR ist hier die Wahrheit)
            if(newEntry.trades && newEntry.trades.length > 0) {
                data[k].trades = newEntry.trades;
                data[k].total = newEntry.total;
            }

            // 2. Notizen sch√ºtzen
            // Wenn Import leer ist, behalte alte Notiz. Wenn Import Text hat, nimm Import.
            if (newEntry.note && newEntry.note.trim() !== "") {
                data[k].note = newEntry.note;
            }

            // 3. Screenshots zusammenf√ºhren
            const oldS = oldEntry.screenshots || [];
            const newS = newEntry.screenshots || [];
            data[k].screenshots = [...new Set([...oldS, ...newS])];

            // 4. GEB√úHREN SCH√úTZEN (Der Fix!)
            // Fall A: Import hat Geb√ºhren (> 0) -> Wir nehmen die neuen (wahrscheinlich genauer)
            if (newEntry.fees && newEntry.fees > 0) {
                data[k].fees = newEntry.fees;
            }
            // Fall B: Import hat 0 oder keine Geb√ºhren, aber wir haben alte -> ALTE BEHALTEN!
            else if (oldEntry.fees && oldEntry.fees > 0) {
                // Wir tun NICHTS. data[k].fees bleibt, wie es war.
            }
            // Fall C: Weder noch -> Bleibt 0.
        }
        count++;
    }
    
    save();
    init();
    renderCal();
    alert(`‚úÖ Import erfolgreich!\n${count} Tage aktualisiert.\nGeb√ºhren von nicht betroffenen Tagen wurden gesch√ºtzt.`);
}

// 2. ZIP IMPORT LISTENER (REPARIERT)
document.getElementById('zipFile').onchange = async function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    // Button Feedback
    const btn = document.querySelector('button[onclick="document.getElementById(\'zipFile\').click()"]');
    const oldText = btn ? btn.textContent : "";
    if(btn) { btn.textContent = "‚è≥ Importiere ZIP..."; btn.disabled = true; }
    
    try {
        const zip = await JSZip.loadAsync(file);
        let csvText = null;
        
        // CSV suchen
        if(zip.file("pnl_data.csv")) {
            csvText = await zip.file("pnl_data.csv").async("text");
        } else {
            // Fallback
            for (const f in zip.files) {
                if (f.endsWith('.csv')) { csvText = await zip.file(f).async("text"); break; }
            }
        }
        
        if (!csvText) throw new Error("Keine CSV im ZIP gefunden!");

        // Daten parsen
        const newData = parseCSV(csvText);

        // --- BILDER IMPORT (FIXED) ---
        // Wir gehen alle Dateien im ZIP durch und pr√ºfen den Pfad manuell
        // Das ist stabiler als zip.folder()
        for (const filename in zip.files) {
            // Wir suchen Dateien, die im Ordner "screenshots/" liegen und keine Ordner sind
            if (filename.startsWith("screenshots/") && !zip.files[filename].dir) {
                
                // Datei aus dem Haupt-Objekt holen (sicherer Zugriff)
                const fileObj = zip.file(filename);
                
                if (fileObj) {
                    const blob = await fileObj.async("blob");
                    // Dateinamen bereinigen: "screenshots/meinbild.jpg" -> "meinbild.jpg"
                    const cleanName = filename.split('/').pop();
                    
                    if (cleanName) {
                        await saveImageToDB(cleanName, blob);
                    }
                }
            }
        }
        
        mergeData(newData);
        
    } catch (err) {
        console.error(err);
        alert('‚ùå ZIP Fehler: ' + err.message);
    } finally {
        if(btn) { btn.textContent = oldText; btn.disabled = false; }
        e.target.value = '';
    }
};

// 3. CSV IMPORT LISTENER
document.getElementById('csvFile').onchange = function(e) {
    const file = e.target.files[0];
    if(!file) return;
    
    const reader = new FileReader();
    reader.onload = function(ev) {
        try {
            const newData = parseCSV(ev.target.result);
            mergeData(newData);
        } catch(err) {
            console.error(err); 
            alert('‚ùå CSV Fehler: Ist das Format korrekt?');
        }
    };
    reader.readAsText(file);
    e.target.value = '';
};

function updateDataInfo(){
    const c=Object.keys(data).length;
    const t=Object.values(data).reduce((s,v)=>{
        return s + (typeof v === 'number' ? v : v.total);
    },0);
    document.getElementById('dataInfo').innerHTML=`<strong>${c}</strong> Eintr√§ge<br>Gesamt: <strong style="color:${t>=0?'#37b24d':'#fa5252'}">${t>=0?'+':''}${t.toFixed(2)}</strong>`;
}

document.getElementById('modal').onclick=function(e){if(e.target===this)closeModal()};
window.onbeforeunload=save;
setInterval(save,30000);
// --- SCREENSHOT LOGIC (NEU) ---

function handleFileSelect(e) {
    const files = e.target.files;
    processFiles(files);
    e.target.value = ''; // Reset input
}

function processFiles(files) {
    if (todayScreenshots.length + files.length > 5) {
        alert("Maximal 5 Screenshots erlaubt!");
        return;
    }

    Array.from(files).forEach(file => {
        if (!file.type.match('image.*')) {
            alert("Nur Bilder (JPEG/PNG) erlaubt!");
            return;
        }
        todayScreenshots.push(file);
    });

    renderScreenshots();
}

function renderScreenshots() {
    const container = document.getElementById('screenshotPreviews');
    if(!container) return;
    container.innerHTML = '';
    
    // CSS-Safety
    container.style.display = 'flex'; container.style.flexWrap = 'wrap'; container.style.gap = '10px'; container.style.marginTop = '10px';

    todayScreenshots.forEach((file, index) => {
        const div = document.createElement('div');
        div.className = 'preview-item';
        div.style.width = '100px'; div.style.height = '100px'; div.style.position = 'relative'; 
        div.style.overflow = 'hidden'; div.style.borderRadius = '8px'; div.style.border = '1px solid #e9ecef'; div.style.flexShrink = '0';

        const btn = document.createElement('div');
        btn.className = 'btn-remove-img';
        btn.innerHTML = '‚úï';
        btn.style.position = 'absolute'; btn.style.top = '2px'; btn.style.right = '2px'; btn.style.width = '20px'; btn.style.height = '20px'; btn.style.background = 'rgba(255,0,0,0.8)'; btn.style.color = 'white'; btn.style.borderRadius = '50%'; btn.style.textAlign = 'center'; btn.style.lineHeight = '20px'; btn.style.cursor = 'pointer'; btn.style.fontSize = '12px'; btn.style.zIndex = '10';
        
        btn.onclick = (e) => { e.stopPropagation(); removeScreenshot(index); };
        
        const img = document.createElement('img');
        if (file instanceof File || file instanceof Blob) {
            img.src = URL.createObjectURL(file);
        }
        img.style.width = '100%'; img.style.height = '100%'; img.style.objectFit = 'cover'; img.style.display = 'block';

        // Doppelklick
        img.ondblclick = () => {
            const newTab = window.open();
            if(newTab) newTab.document.write(`<html><body style="margin:0;background:#222;display:flex;justify-content:center;align-items:center;height:100vh;"><img src="${img.src}" style="max-width:100%;max-height:100%"></body></html>`);
        };

        div.appendChild(img);
        div.appendChild(btn);
        container.appendChild(div);

        // --- HIER IST DER HOVER AUFRUF ---
        addHoverPreview(div, img.src);
    });
}

function removeScreenshot(index) {
    clearAllPreviews(); // <--- ZWANGS-L√ñSCHUNG
    todayScreenshots.splice(index, 1);
    renderScreenshots();
}
// --- MODAL SCREENSHOT LOGIC (NEU) ---
let currentModalScreenshots = [];

function handleModalFileSelect(e) {
    processModalFiles(e.target.files);
    e.target.value = '';
}

function processModalFiles(files) {
    if (currentModalScreenshots.length + files.length > 5) {
        alert("Maximal 5 Screenshots erlaubt!");
        return;
    }
    Array.from(files).forEach(file => {
        if (!file.type.match('image.*')) { alert("Nur Bilder!"); return; }
        currentModalScreenshots.push(file);
    });
    renderModalScreenshots();
}

function removeModalScreenshot(index) {
    clearAllPreviews(); // <--- ZWANGS-L√ñSCHUNG
    currentModalScreenshots.splice(index, 1);
    renderModalScreenshots();
}

function renderModalScreenshots() {
    const container = document.getElementById('modalScreenshotPreviews');
    if(!container) return;
    container.innerHTML = '';

    // Erzwinge Flex-Layout wie bei der Hauptseite
    container.style.display = 'flex';
    container.style.flexWrap = 'wrap';
    container.style.gap = '10px';
    container.style.marginTop = '10px';

    currentModalScreenshots.forEach((file, index) => {
        const div = document.createElement('div');
        div.className = 'preview-item';
        // Styles direkt setzen (Stabilit√§t!)
        div.style.width = '100px'; 
        div.style.height = '100px'; 
        div.style.position = 'relative';
        div.style.overflow = 'hidden'; 
        div.style.borderRadius = '8px'; 
        div.style.border = '1px solid #e9ecef'; 
        div.style.flexShrink = '0';
        div.style.background = '#fff';

        const btn = document.createElement('div');
        btn.className = 'btn-remove-img';
        btn.innerHTML = '‚úï';
        btn.style.position = 'absolute'; 
        btn.style.top = '2px'; 
        btn.style.right = '2px';
        btn.style.width = '20px'; 
        btn.style.height = '20px'; 
        btn.style.background = 'rgba(255,0,0,0.8)';
        btn.style.color = 'white'; 
        btn.style.borderRadius = '50%'; 
        btn.style.textAlign = 'center'; 
        btn.style.lineHeight = '20px'; 
        btn.style.cursor = 'pointer'; 
        btn.style.fontSize = '12px'; 
        btn.style.zIndex = '10';
        
        btn.onclick = (e) => { e.stopPropagation(); removeModalScreenshot(index); };

        const img = document.createElement('img');
        if (file instanceof File || file instanceof Blob) {
            img.src = URL.createObjectURL(file);
        }
        
        img.style.width = '100%'; 
        img.style.height = '100%'; 
        img.style.objectFit = 'cover'; 
        img.style.display = 'block';
        
        img.ondblclick = () => {
            const newTab = window.open();
            if(newTab) newTab.document.write(`<html><body style="margin:0;background:#222;display:flex;justify-content:center;align-items:center;height:100vh;"><img src="${img.src}" style="max-width:100%;max-height:100%"></body></html>`);
        };

        div.appendChild(img);
        div.appendChild(btn);
        container.appendChild(div);
        // --- HIER IST DER HOVER AUFRUF ---
        addHoverPreview(div, img.src);
    });
}
// --- HOVER EFFECT HELPER ---
// --- HOVER EFFECT HELPER (VERGR√ñSSERT) ---
// --- HOVER EFFECT HELPER (MIT CLEANUP KLASSE) ---
function addHoverPreview(targetDiv, imgSrc) {
    let previewDiv = null;

    targetDiv.addEventListener('mouseenter', () => {
        // Erstmal aufr√§umen, falls noch alte Popups da sind
        clearAllPreviews();

        previewDiv = document.createElement('div');
        // WICHTIG: Wir geben dem Ding eine Klasse!
        previewDiv.className = 'hover-preview-overlay'; 
        
        previewDiv.style.cssText = `
            position: fixed;
            z-index: 10000;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 5px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
            pointer-events: none;
            width: 400px;
            height: 400px;
            display: flex;
            justify-content: center;
            align-items: center;
        `;
        
        const img = document.createElement('img');
        img.src = imgSrc;
        img.style.cssText = "max-width:100%; max-height:100%; object-fit:contain; border-radius:4px;";
        
        previewDiv.appendChild(img);
        document.body.appendChild(previewDiv);

        // Position berechnen
        const rect = targetDiv.getBoundingClientRect();
        let leftPos = rect.right + 20;
        let topPos = rect.top;
        
        if (leftPos + 420 > window.innerWidth) leftPos = rect.left - 425; 
        if (topPos + 420 > window.innerHeight) topPos = window.innerHeight - 420;
        if (topPos < 10) topPos = 10;

        previewDiv.style.left = leftPos + 'px';
        previewDiv.style.top = topPos + 'px';
    });

    targetDiv.addEventListener('mouseleave', () => {
        if (previewDiv) {
            previewDiv.remove();
            previewDiv = null;
        }
    });
}

// NEUE HILFSFUNKTION: L√∂scht alle Popups gewaltsam
function clearAllPreviews() {
    const existing = document.querySelectorAll('.hover-preview-overlay');
    existing.forEach(el => el.remove());
}

// ==========================================
// === STEUER & PDF LOGIK (SCHAFFHAUSEN) ===
// ==========================================

let taxData = { personal: {}, balances: {} };

// 1. Laden und Speichern der Steuerdaten (separat von Trading-Daten)
function loadTaxData() {
    const l = localStorage.getItem('tradeLog_tax');
    if(l) taxData = JSON.parse(l);
    
    // Felder f√ºllen
    if(document.getElementById('taxName')) {
        document.getElementById('taxName').value = taxData.personal.name || '';
        document.getElementById('taxAddress').value = taxData.personal.address || '';
        document.getElementById('taxZip').value = taxData.personal.zip || '';
        document.getElementById('taxCity').value = taxData.personal.city || '';
        document.getElementById('taxId').value = taxData.personal.id || '';
    }
}

// Speicher-Funktion mit "Stumm-Schaltung"
function saveTaxData(silent = false) {
    taxData.personal = {
        name: document.getElementById('taxName').value,
        address: document.getElementById('taxAddress').value,
        zip: document.getElementById('taxZip').value,
        city: document.getElementById('taxCity').value,
        id: document.getElementById('taxId').value
    };
    
    // In LocalStorage speichern
    localStorage.setItem('tradeLog_tax', JSON.stringify(taxData));
    
    // In IndexedDB speichern (f√ºr Backup)
    openDB().then(db => {
        const tx = db.transaction(STORE_SETTINGS, 'readwrite');
        tx.objectStore(STORE_SETTINGS).put(taxData, 'taxData');
    });

    // Nur Meldung zeigen, wenn NICHT stummgeschaltet
    if (!silent) {
        alert("Daten gespeichert! ‚úì");
    }
}

// 2. Navigation im Steuer-Tab
function switchTaxSubView(view) {
    // 1. Views umschalten
    document.querySelectorAll('.tax-subview').forEach(e => e.classList.remove('active'));
    document.getElementById('tax-' + view).classList.add('active');
    
    // 2. Buttons f√§rben (Robuste Methode)
    document.querySelectorAll('.tax-nav-btn').forEach(btn => {
        btn.classList.remove('active');
        // Wir pr√ºfen, ob im "onclick" Text der Name des Views vorkommt
        // z.B. onclick="switchTaxSubView('overview')" enth√§lt 'overview'
        if(btn.getAttribute('onclick').includes(`'${view}'`)) {
            btn.classList.add('active');
        }
    });

    if(view === 'overview') renderTaxOverview();
    if(view === 'balances') renderBalances();
    if(view === 'expenses') renderExpenses();
    if(view === 'export') renderTaxExport();
}

// --- STEUER √úBERSICHT (MIT INTELLIGENTER GEB√úHREN-BERECHNUNG) ---
function renderTaxOverview() {
    const div = document.getElementById('taxOverviewContent');
    const years = new Set();
    Object.keys(data).forEach(k => years.add(k.split('-')[0]));
    
    let html = '<table style="width:100%; border-collapse:collapse; font-size:0.9em;">';
    html += '<tr style="background:#f1f3f5; text-align:left;"> <th style="padding:8px;">Jahr</th> <th style="text-align:right">Netto (USD)</th> <th style="text-align:right">Geb√ºhren (USD)</th> </tr>';
    
    Array.from(years).sort().reverse().forEach(y => {
        let net = 0, fees = 0;
        
        Object.keys(data).filter(k => k.startsWith(y)).forEach(k => {
            const d = data[k];
            net += d.total || 0;
            
            // INTELLIGENTE GEB√úHREN-LOGIK:
            let dailyFees = 0;
            if (d.fees && d.fees > 0) {
                // A) Wir haben echte Import-Daten
                dailyFees = d.fees;
            } else if (d.trades && d.trades.length > 0) {
                // B) Keine Daten? Wir sch√§tzen anhand der Trades (wie in Statistik)
                d.trades.forEach(t => dailyFees += getComm(t.inst, t.qty));
            }
            fees += dailyFees;
        });
        
        html += `
            <tr style="border-bottom:1px solid #eee;">
                <td style="padding:8px; font-weight:bold;">${y}</td>
                <td style="text-align:right; color:${net >= 0 ? '#2b8a3e' : '#c92a2a'}">${net.toFixed(2)}</td>
                <td style="text-align:right; color:#e67700">-${fees.toFixed(2)}</td>
            </tr>`;
    });
    html += '</table>';
    div.innerHTML = html;
}

// 4. Verm√∂gen (Kontost√§nde)
function renderBalances() {
    const div = document.getElementById('balanceEntries');
    div.innerHTML = '';
    
    // Wir nehmen die Jahre aus den Trading-Daten als Basis
    const years = new Set(); 
    Object.keys(data).forEach(k => years.add(k.split('-')[0]));
    // Plus evtl. schon gespeicherte Jahre
    Object.keys(taxData.balances).forEach(y => years.add(y));
    
    Array.from(years).sort().reverse().forEach(y => {
        const bal = taxData.balances[y] || { start: 0, end: 0 };
        
        const row = document.createElement('div');
        row.className = 'form-group';
        row.innerHTML = `
            <label style="color:#1971c2">Steuerjahr ${y}</label>
            <div style="display:flex; gap:10px;">
                <div style="flex:1">
                    <small>01.01. (CHF)</small>
                    <input type="number" step="0.01" value="${bal.start}" onchange="updateBalance('${y}', 'start', this.value)">
                </div>
                <div style="flex:1">
                    <small>31.12. (CHF)</small>
                    <input type="number" step="0.01" value="${bal.end}" onchange="updateBalance('${y}', 'end', this.value)">
                </div>
            </div>
        `;
        div.appendChild(row);
    });
}

function updateBalance(year, type, val) {
    if(!taxData.balances[year]) taxData.balances[year] = { start: 0, end: 0 };
    taxData.balances[year][type] = parseFloat(val) || 0;
    localStorage.setItem('tradeLog_tax', JSON.stringify(taxData));
}

function addBalanceYear() {
    const y = prompt("Welches Jahr hinzuf√ºgen? (z.B. 2026)");
    if(y && y.length === 4) {
        if(!taxData.balances[y]) taxData.balances[y] = { start: 0, end: 0 };
        renderBalances();
    }
}

// 5. Export Vorbereitung
function renderTaxExport() {
    const select = document.getElementById('taxYearSelect');
    select.innerHTML = '<option value="">Bitte Jahr w√§hlen...</option>';
    const years = new Set();
    Object.keys(data).forEach(k => years.add(k.split('-')[0]));
    
    Array.from(years).sort().reverse().forEach(y => {
        const opt = document.createElement('option');
        opt.value = y;
        opt.text = y;
        select.add(opt);
    });
}

// --- PDF GENERATOR (MIT CHF JOURNAL & FEHLER-ANZEIGE) ---
async function generateTaxPDF() {
    try {
        // 1. INPUTS PR√úFEN
        const year = document.getElementById('taxYearSelect').value;
        if(!year || year.length < 4) throw new Error("Bitte w√§hle zuerst ein Steuerjahr aus.");
        
        const rate = parseFloat(document.getElementById('taxExchangeRate').value);
        if(!rate || rate <= 0) throw new Error("Bitte gib einen g√ºltigen Wechselkurs ein.");

        // 2. BIBLIOTHEK PR√úFEN (Wichtig f√ºr GitHub!)
        if (!window.jspdf || !window.jspdf.jsPDF) {
            throw new Error("PDF-Bibliothek nicht geladen. Bitte Seite neu laden!");
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const p = taxData.personal;

        // ==========================================
        // SEITE 1: ZUSAMMENFASSUNG
        // ==========================================

        doc.setFontSize(22); doc.setTextColor(44, 62, 80);
        doc.text("Jahresabschluss Trading", 105, 20, { align: 'center' });
        doc.setFontSize(12); doc.setTextColor(100);
        doc.text(`Steuerperiode ${year} | Kanton Schaffhausen`, 105, 28, { align: 'center' });
        
        doc.setDrawColor(200); doc.line(20, 35, 190, 35);
        doc.setFontSize(10); doc.setTextColor(0);
        doc.text(`Name: ${p.name || '-'}`, 20, 45);
        doc.text(`PID: ${p.id || '-'}`, 120, 45);
        doc.text(`Adresse: ${p.address || '-'}, ${p.zip || ''} ${p.city || '-'}`, 20, 50);

        // --- DATEN BERECHNEN ---
        let netPnL_USD = 0;
        let totalFees_USD = 0;
        
        const sortedDays = Object.keys(data).filter(k => k.startsWith(year)).sort();

        sortedDays.forEach(k => {
            const d = data[k];
            netPnL_USD += d.total || 0; 
            
            let dailyFees = 0;
            if (d.fees && d.fees > 0) dailyFees = d.fees;
            else if (d.trades) d.trades.forEach(t => dailyFees += getComm(t.inst, t.qty));
            totalFees_USD += dailyFees;
        });
        
        const grossPnL_USD = netPnL_USD + totalFees_USD;
        const grossCHF = grossPnL_USD * rate;
        const feesCHF = totalFees_USD * rate;
        const netCHF = netPnL_USD * rate;

        // 1. ERFOLGSRECHNUNG
        doc.setFont(undefined, 'bold');
        doc.text("1. Handelsergebnis (Wertschriftenhandel)", 20, 65);
        
        const tradeBody = [
            ['Brutto-Handelsgewinn', grossPnL_USD.toFixed(2) + ' USD', grossCHF.toFixed(2) + ' CHF'],
            ['./. Transaktionskosten (Commissions)', '-' + totalFees_USD.toFixed(2) + ' USD', '-' + feesCHF.toFixed(2) + ' CHF'],
            ['= NETTO HANDELSGEWINN', netPnL_USD.toFixed(2) + ' USD', netCHF.toFixed(2) + ' CHF']
        ];
        
        doc.autoTable({
            startY: 70,
            head: [['Position', 'Betrag (Orig.)', 'Betrag (CHF)']],
            body: tradeBody,
            theme: 'grid',
            headStyles: { fillColor: [44, 62, 80] },
            foot: [['Kurs: 1 USD = ' + rate + ' CHF (ESTV Jahresmittel)', '', '']],
            footStyles: { fillColor: [240, 240, 240], textColor: [50], fontStyle: 'italic' }
        });

        // 2. AUSGABEN
        let finalY = doc.lastAutoTable.finalY + 15;
        const rateEUR = parseFloat(document.getElementById('taxExchangeRateEUR')?.value) || 0.94;
        const expenses = (taxData.expenses || []).filter(e => e.year === year);
        
        if (expenses.length > 0) {
            doc.setFont(undefined, 'bold');
            doc.text("2. Geltend gemachte Aufwendungen", 20, finalY);
            
            let totalExpCHF = 0;
            const expBody = expenses.map(e => {
                const r = e.rate || 1.00;
                const amountCHF = e.amount * r;
                totalExpCHF += amountCHF;
                
                // Fix f√ºr "undefined" Kategorie
                const category = e.cat ? e.cat : 'Sonstiges';
                const currency = e.currency || 'CHF';
                const rateInfo = currency !== 'CHF' ? `(@ ${r})` : '';

                return [
                    category + ` (${e.desc})`,
                    `${e.amount.toFixed(2)} ${currency} ${rateInfo}`,
                    '-' + amountCHF.toFixed(2) + ' CHF'
                ];
            });
            
            expBody.push(['Total Aufwendungen', '', '-' + totalExpCHF.toFixed(2) + ' CHF']);
            
            // REINGEWINN
            const finalProfitCHF = netCHF - totalExpCHF;
            expBody.push(['', '', '']); 
            expBody.push(['REINGEWINN (zu versteuern)', '', finalProfitCHF.toFixed(2) + ' CHF']);
            
            doc.autoTable({
                startY: finalY + 5,
                head: [['Position', 'Original', 'Betrag (CHF)']],
                body: expBody,
                theme: 'striped',
                headStyles: { fillColor: [100, 100, 100] },
                columnStyles: { 2: { halign: 'right', fontStyle: 'bold' }, 1: { halign: 'right' } }
            });
            finalY = doc.lastAutoTable.finalY + 15;
        } else {
            doc.setFontSize(10); doc.setFont(undefined, 'italic');
            doc.text("(Keine weiteren Aufwendungen geltend gemacht)", 20, finalY);
            finalY += 10;
        }

        // 3. VERM√ñGEN
        doc.setFontSize(12); doc.setFont(undefined, 'bold');
        doc.text("3. Verm√∂gensstatus", 20, finalY);
        const bal = taxData.balances[year] || { start: 0, end: 0 };
        doc.autoTable({
            startY: finalY + 5,
            body: [
                ['Kontostand 01.01.' + year, bal.start.toFixed(2) + ' CHF'],
                ['Kontostand 31.12.' + year, bal.end.toFixed(2) + ' CHF']
            ],
            theme: 'plain'
        });

        // ==========================================
        // SEITE 2: JOURNAL MIT CHF UMRECHNUNG
        // ==========================================
        
        doc.addPage();
        doc.setFontSize(12); doc.setFont(undefined, 'bold');
        doc.text("4. Detailliertes Trading-Journal (Nachweis)", 20, 20);
        
        const journalBody = [];
        
        sortedDays.forEach(k => {
            const d = data[k];
            const net = d.total || 0;
            let fees = 0;
            if (d.fees && d.fees > 0) fees = d.fees;
            else if (d.trades) d.trades.forEach(t => fees += getComm(t.inst, t.qty));
            const gross = net + fees;
            
            if (Math.abs(gross) < 0.01 && Math.abs(fees) < 0.01) return;
            
            const [y, m, day] = k.split('-');
            journalBody.push([`${day}.${m}.${y}`, gross.toFixed(2), '-' + fees.toFixed(2), net.toFixed(2)]);
        });
        
        // Summenzeile USD
        journalBody.push([
            'TOTAL JAHR (USD)',
            grossPnL_USD.toFixed(2),
            '-' + totalFees_USD.toFixed(2),
            netPnL_USD.toFixed(2)
        ]);

        // NEU: Summenzeile CHF (Abgleich)
        journalBody.push([
            'TOTAL JAHR (CHF @ ' + rate + ')',
            (grossPnL_USD * rate).toFixed(2),
            '-' + (totalFees_USD * rate).toFixed(2),
            (netPnL_USD * rate).toFixed(2) // Das muss = "Betrag (CHF)" Seite 1 sein
        ]);

        doc.autoTable({
            startY: 25,
            head: [['Datum', 'Brutto (USD)', 'Geb√ºhren (USD)', 'Netto (USD)']],
            body: journalBody,
            theme: 'grid',
            headStyles: { fillColor: [50, 50, 50] },
            columnStyles: { 1: {halign:'right'}, 2: {halign:'right', textColor:[200,0,0]}, 3: {halign:'right', fontStyle:'bold'} },
            // Styling f√ºr die letzten ZWEI Zeilen (Total USD und Total CHF)
            didParseCell: function (data) {
                const rows = journalBody.length;
                if (data.row.index === rows - 2) { // Total USD
                    data.cell.styles.fontStyle = 'bold';
                    data.cell.styles.fillColor = [240, 240, 240];
                }
                if (data.row.index === rows - 1) { // Total CHF
                    data.cell.styles.fontStyle = 'bold';
                    data.cell.styles.fillColor = [220, 230, 240]; // Leicht bl√§ulich zur Unterscheidung
                    data.cell.styles.textColor = [0, 0, 0];
                }
            }
        });

        // Unterschrift
        let signY = doc.lastAutoTable.finalY + 30;
        if (signY > 250) { doc.addPage(); signY = 40; }
        
        doc.setFontSize(10); doc.setFont(undefined, 'normal');
        doc.text("Ort, Datum: __________________________   Unterschrift: __________________________", 20, signY);

        // Speichern
        const safeName = (p.name || 'Steuer').replace(/[^a-z0-9]/gi, '_');
        doc.save(`Steuerreport_${year}_${safeName}.pdf`);

    } catch(e) {
        // HIER FANGEN WIR DEN FEHLER AB UND ZEIGEN IHN AN!
        console.error(e);
        alert("‚ùå PDF Fehler: " + e.message + "\n\nTipp: Lade die Seite neu, damit die Bibliotheken laden k√∂nnen.");
    }
}

// Initialisierung auch f√ºr Steuerdaten aufrufen
const originalInit = window.onload; // Falls vorhanden
// Wir packen den Load-Aufruf in den bestehenden Init-Flow oder rufen ihn manuell auf.
// Da du "load()" am Ende des Scripts hast, f√ºgen wir "loadTaxData()" dort hinzu.
// Siehe Schritt 5.

load();
// --- PASTE SUPPORT (STRG+V / CMD+V) ---
document.addEventListener('paste', function(e) {
    // 1. Inhalt der Zwischenablage pr√ºfen
    const items = (e.clipboardData || e.originalEvent.clipboardData).items;
    const files = [];

    // Nach Bildern suchen
    for (let i = 0; i < items.length; i++) {
        // Wenn es ein Bild ist...
        if (items[i].type.indexOf("image") !== -1) {
            const blob = items[i].getAsFile();
            files.push(blob);
        }
    }

    // Wenn keine Bilder gefunden wurden, brechen wir ab 
    // (damit du weiterhin Text in deine Notizen pasten kannst!)
    if (files.length === 0) return;

    // 2. Pr√ºfen: Wo befinden wir uns gerade?
    const modal = document.getElementById('modal');
    const todayView = document.getElementById('today');
    const todayNotesTab = document.getElementById('today-notes');

    // FALL A: Das Bearbeiten-Fenster (Modal) ist offen
    if (modal && modal.classList.contains('active')) {
        // Wir pr√ºfen, ob der Notiz-Tab im Modal sichtbar ist (optional, aber sauberer)
        const modalNotesTab = document.getElementById('tab-notes');
        if(modalNotesTab && modalNotesTab.style.display !== 'none') {
            e.preventDefault(); // Verhindert, dass der Browser versucht, das Bild ins Textfeld zu quetschen
            processModalFiles(files); // Ab in die Modal-Logik
            return;
        }
    }

    // FALL B: Wir sind in der "Heute"-Ansicht
    if (todayView && todayView.classList.contains('active')) {
        // Wir pr√ºfen, ob der Notiz-Tab aktiv ist
        if (todayNotesTab && todayNotesTab.classList.contains('active')) {
            e.preventDefault();
            processFiles(files); // Ab in die Heute-Logik
        }
    }
});

// --- AUSGABEN LOGIC (LIVE UPDATE FIX) ---
function renderExpenses() {
    const container = document.getElementById('expenseEntries');
    if(!container) return;
    container.innerHTML = '';
    
    if(!taxData.expenses) taxData.expenses = [];
    
    taxData.expenses.forEach((ex, i) => {
        if(!ex.currency) ex.currency = 'CHF';
        // Wenn kein Kurs da ist (oder 0), Standard auf 1
        if(ex.rate === undefined || ex.rate === null || ex.rate === '') ex.rate = 1.00;

        const div = document.createElement('div');
        div.style.marginBottom = "15px";
        div.style.padding = "15px";
        div.style.background = "#fff";
        div.style.borderRadius = "8px";
        div.style.border = "1px solid #e9ecef";
        div.style.borderLeft = "5px solid #17a2b8";

        // Sofortige Berechnung f√ºr die Anzeige
        const amount = parseFloat(ex.amount) || 0;
        const rate = parseFloat(ex.rate) || 0;
        const totalCHF = (amount * rate).toFixed(2);

        div.innerHTML = `
            <!-- ZEILE 1: Beschreibung & Jahr -->
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <div style="flex:2">
                    <label style="font-size:0.75em; color:#666; font-weight:bold;">Beschreibung</label>
                    <input type="text" value="${ex.desc}" 
                           oninput="updateExp(${i},'desc',this.value)" 
                           style="width:100%; padding:8px; border:1px solid #ced4da; border-radius:4px;">
                </div>
                <div style="flex:1">
                    <label style="font-size:0.75em; color:#666; font-weight:bold;">Steuerjahr</label>
                    <select onchange="updateExp(${i},'year',this.value)" 
                            style="width:100%; padding:8px; border:1px solid #ced4da; border-radius:4px; background:white;">
                        <option value="2025" ${ex.year==='2025'?'selected':''}>2025</option>
                        <option value="2026" ${ex.year==='2026'?'selected':''}>2026</option>
                    </select>
                </div>
            </div>
            
            <!-- ZEILE 2: Kategorie -->
            <div style="margin-bottom:10px;">
                <label style="font-size:0.75em; color:#666; font-weight:bold;">Kategorie</label>
                <select style="width:100%; padding:8px; border:1px solid #ced4da; border-radius:4px; background:white;" 
                        onchange="updateExp(${i},'cat',this.value)">
                    <option value="Software/Daten" ${ex.cat==='Software/Daten'?'selected':''}>Software / Daten</option>
                    <option value="Hardware" ${ex.cat==='Hardware'?'selected':''}>Hardware / B√ºro</option>
                    <option value="Bildung" ${ex.cat==='Bildung'?'selected':''}>Bildung / Kurse</option>
                    <option value="S√§ule 3a" ${ex.cat==='S√§ule 3a'?'selected':''}>S√§ule 3a</option>
                    <option value="Krankenkasse" ${ex.cat==='Krankenkasse'?'selected':''}>Krankenkasse</option>
                    <option value="Werbung" ${ex.cat==='Werbung'?'selected':''}>Werbekosten</option>
                    <option value="Sonstiges" ${ex.cat==='Sonstiges'?'selected':''}>Sonstiges</option>
                </select>
            </div>

            <!-- ZEILE 3: Betrag, W√§hrung, Kurs, L√∂schen -->
            <div style="display:flex; gap:10px; align-items:flex-end;">
                
                <!-- Betrag -->
                <div style="flex:2">
                    <label style="font-size:0.75em; color:#666; font-weight:bold;">Betrag</label>
                    <input type="number" step="0.01" value="${ex.amount}" 
                           oninput="updateExp(${i},'amount',this.value)" 
                           style="width:100%; padding:8px; border:1px solid #ced4da; border-radius:4px;">
                </div>
                
                <!-- W√§hrung -->
                <div style="width:80px">
                    <label style="font-size:0.75em; color:#666; font-weight:bold;">W√§hrung</label>
                    <select style="width:100%; padding:8px; border:1px solid #ced4da; border-radius:4px; background:white;" 
                            onchange="updateExp(${i},'currency',this.value)">
                        <option value="CHF" ${ex.currency==='CHF'?'selected':''}>CHF</option>
                        <option value="USD" ${ex.currency==='USD'?'selected':''}>USD</option>
                        <option value="EUR" ${ex.currency==='EUR'?'selected':''}>EUR</option>
                    </select>
                </div>

                <!-- Kurs -->
                <div style="flex:1">
                    <label style="font-size:0.75em; color:#666; font-weight:bold;">Kurs zu CHF</label>
                    <input type="number" step="0.0001" value="${ex.rate}" 
                           oninput="updateExp(${i},'rate',this.value)" 
                           style="width:100%; padding:8px; border:1px solid #ced4da; border-radius:4px;">
                </div>
                
                <!-- L√∂schen Button -->
                <button onclick="removeExp(${i})" 
                        style="width:40px; height:38px; background:#fa5252; color:white; border:none; border-radius:4px; cursor:pointer; flex-shrink:0; margin-bottom:1px;">
                    ‚úï
                </button>
            </div>
            
            <!-- Live Vorschau (Mit ID f√ºr Update) -->
            <div id="preview_${i}" style="text-align:right; font-size:0.9em; color:#1971c2; margin-top:8px; font-weight:bold; padding-top:5px; border-top:1px dashed #eee;">
                = ${totalCHF} CHF
            </div>
        `;
        container.appendChild(div);
    });
}

function updateExp(i, field, val) {
    // 1. Daten im Hintergrund-Objekt aktualisieren
    // Wir speichern den Wert direkt (auch als String), damit das Eingabefeld nicht springt (z.B. bei "10.")
    taxData.expenses[i][field] = val;

    // 2. Spezialfall: W√§hrung auf CHF ge√§ndert -> Kurs auf 1 setzen
    if(field === 'currency' && val === 'CHF') {
        taxData.expenses[i].rate = 1.00;
        renderExpenses(); // Hier m√ºssen wir neu rendern, um das Kurs-Feld zu aktualisieren
        return;
    }

    // 3. LIVE UPDATE DES TEXTES (Ohne Re-Render!)
    // Wir suchen nur das blaue Textfeld f√ºr diese Zeile
    const previewEl = document.getElementById('preview_' + i);
    if (previewEl) {
        const amount = parseFloat(taxData.expenses[i].amount) || 0;
        const rate = parseFloat(taxData.expenses[i].rate) || 0;
        const total = (amount * rate).toFixed(2);
        
        previewEl.innerHTML = `= ${total} CHF`;
    }
}

function addExpenseItem() {
    if(!taxData.expenses) taxData.expenses = [];
    taxData.expenses.push({ 
        desc: '', amount: 0, year: new Date().getFullYear().toString(), 
        cat: 'Software/Daten', currency: 'CHF', rate: 1.00 
    });
    // Nur beim Hinzuf√ºgen rendern wir neu
    renderExpenses();
}

function removeExp(i) {
    taxData.expenses.splice(i, 1);
    // Beim L√∂schen rendern wir neu
    renderExpenses();
}

</script>
</body>
</html>
